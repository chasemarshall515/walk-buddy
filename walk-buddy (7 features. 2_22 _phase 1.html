<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walk Buddy</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ */
  :root {
    --primary: #8FAF8C;
    --bg: #F7F3EC;
    --dark: #3D2B1F;
    --mid: #D4C5A9;
    --accent: #7BADC4;
    --warm: #E8D5B7;
    --card: #ffffff;
    --text-sub: #7a6355;
    --text-muted: #9a8878;
  }
  [data-theme="ocean"] {
    --primary: #5B9EC9;
    --bg: #EEF5FA;
    --dark: #1A3A4A;
    --mid: #B8D4E8;
    --accent: #F4A261;
    --warm: #D6EAF5;
    --card: #ffffff;
    --text-sub: #3a6070;
    --text-muted: #7a9aaa;
  }
  [data-theme="city"] {
    --primary: #A0A0A0;
    --bg: #1A1A1A;
    --dark: #F0F0F0;
    --mid: #333333;
    --accent: #E8C547;
    --warm: #2A2A2A;
    --card: #242424;
    --text-sub: #A0A0A0;
    --text-muted: #707070;
  }
  [data-theme="bloom"] {
    --primary: #C77DBA;
    --bg: #FDF0F8;
    --dark: #3D1A35;
    --mid: #E8C5DF;
    --accent: #F4A261;
    --warm: #F5E0F0;
    --card: #ffffff;
    --text-sub: #7a3a6a;
    --text-muted: #9a6a8a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.4s, color 0.4s;
  }

  body::before {
    content: '';
    position: fixed;
    top: -120px; right: -120px;
    width: 400px; height: 400px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
    opacity: 0.2;
    pointer-events: none;
    transition: background 0.4s;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -80px; left: -80px;
    width: 300px; height: 300px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
    opacity: 0.15;
    pointer-events: none;
  }

  header {
    padding: 1.5rem 2rem 0.25rem;
    text-align: center;
    animation: fadeDown 0.7s ease both;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 2.8rem;
    color: var(--dark);
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--primary); font-style: italic; }

  .tagline {
    font-size: 0.85rem;
    font-weight: 300;
    color: var(--text-sub);
    margin-top: 0.2rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Theme switcher */
  .theme-row {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    animation: fadeDown 0.7s ease 0.05s both;
  }
  .theme-btn {
    width: 26px; height: 26px;
    border-radius: 50%;
    border: 2.5px solid transparent;
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
  }
  .theme-btn:hover { transform: scale(1.15); }
  .theme-btn.active { border-color: var(--dark); transform: scale(1.15); }
  .theme-btn.forest { background: linear-gradient(135deg, #8FAF8C, #D4C5A9); }
  .theme-btn.ocean  { background: linear-gradient(135deg, #5B9EC9, #B8D4E8); }
  .theme-btn.city   { background: linear-gradient(135deg, #333, #A0A0A0); }
  .theme-btn.bloom  { background: linear-gradient(135deg, #C77DBA, #F5E0F0); }

  /* Top bar */
  .top-bar {
    display: flex;
    justify-content: center;
    gap: 0.6rem;
    padding: 0.4rem 1.5rem 0.6rem;
    max-width: 480px;
    margin: 0 auto;
    animation: fadeDown 0.7s ease 0.1s both;
  }

  .top-pill {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: var(--card);
    border-radius: 100px;
    padding: 0.4rem 0.85rem;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--dark);
    box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    transition: background 0.4s, color 0.4s;
  }
  .top-pill .pill-sub { font-size: 0.68rem; color: var(--text-muted); font-weight: 400; }
  .streak-pill.active { background: var(--dark); color: var(--bg); }
  .streak-pill.active .pill-sub { color: var(--mid); }

  /* Cards */
  .card {
    background: var(--card);
    border-radius: 24px;
    padding: 1.75rem;
    margin: 0.6rem auto;
    max-width: 480px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    animation: fadeUp 0.7s ease 0.2s both;
    transition: background 0.4s;
  }

  .section-label {
    font-size: 0.72rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--primary);
    margin-bottom: 0.7rem;
  }

  .distance-display {
    font-family: 'DM Serif Display', serif;
    font-size: 3.2rem;
    color: var(--dark);
    line-height: 1;
    margin-bottom: 0.2rem;
  }
  .distance-display span { font-size: 1.1rem; font-family: 'DM Sans', sans-serif; font-weight: 300; color: var(--text-sub); }

  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--primary) 0%, var(--primary) var(--pct, 30%), var(--mid) var(--pct, 30%), var(--mid) 100%);
    margin: 0.9rem 0 0.4rem;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--dark);
    border: 3px solid var(--card);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: transform 0.15s;
  }
  input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.15); }

  .range-labels { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--text-muted); }

  .prefs-grid { display: flex; flex-wrap: wrap; gap: 0.45rem; margin-bottom: 0.4rem; }

  .pref-chip {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.45rem 0.9rem;
    border-radius: 100px;
    border: 1.5px solid var(--mid);
    background: transparent;
    cursor: pointer;
    font-size: 0.82rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--dark);
    transition: all 0.18s;
  }
  .pref-chip:hover { border-color: var(--primary); }
  .pref-chip.active { background: var(--dark); border-color: var(--dark); color: var(--bg); }
  .pref-chip .icon { font-size: 0.95rem; }

  .generate-btn {
    width: 100%;
    padding: 0.95rem;
    border-radius: 14px;
    border: none;
    background: var(--dark);
    color: var(--bg);
    font-family: 'DM Serif Display', serif;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1.25rem;
  }
  .generate-btn:hover { opacity: 0.85; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
  .generate-btn:active { transform: translateY(0); }

  #map-section { max-width: 480px; margin: 0 auto 1.5rem; display: none; }

  #map {
    width: 100%;
    height: 360px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
  }

  .route-info { display: flex; gap: 0.6rem; margin-top: 0.7rem; }

  .info-pill {
    flex: 1;
    background: var(--card);
    border-radius: 14px;
    padding: 0.8rem 0.7rem;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
  }
  .info-pill .val { font-family: 'DM Serif Display', serif; font-size: 1.4rem; color: var(--dark); }
  .info-pill .lbl { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-top: 0.1rem; }

  .spots-list { background: var(--card); border-radius: 16px; padding: 1.1rem; margin-top: 0.7rem; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
  .spots-title { font-size: 0.72rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; color: var(--primary); margin-bottom: 0.7rem; }
  .spot-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.45rem 0; border-bottom: 1px solid var(--warm); font-size: 0.88rem; text-decoration: none; color: var(--dark); }
  .spot-item:last-child { border-bottom: none; }
  .spot-item:hover .spot-name { text-decoration: underline; color: var(--primary); }
  .spot-icon { width: 30px; height: 30px; border-radius: 8px; background: var(--warm); display: flex; align-items: center; justify-content: center; font-size: 0.95rem; flex-shrink: 0; }
  .spot-name { font-weight: 500; }
  .spot-type { font-size: 0.75rem; color: var(--text-muted); }
  .spot-arrow { margin-left: auto; font-size: 0.75rem; color: var(--text-muted); }

  .streak-banner {
    background: var(--dark);
    color: var(--bg);
    border-radius: 14px;
    padding: 0.85rem 1.2rem;
    margin-top: 0.7rem;
    text-align: center;
    display: none;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  .streak-banner .streak-num { font-family: 'DM Serif Display', serif; font-size: 1.7rem; }
  .streak-banner .streak-msg { font-size: 0.8rem; color: var(--mid); margin-top: 0.2rem; }

  /* Stats section */
  .stats-card { cursor: default; }
  .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
  .stats-tabs { display: flex; gap: 0.4rem; }
  .stats-tab {
    padding: 0.3rem 0.75rem;
    border-radius: 100px;
    border: 1.5px solid var(--mid);
    background: transparent;
    font-size: 0.75rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--dark);
    cursor: pointer;
    transition: all 0.18s;
  }
  .stats-tab.active { background: var(--dark); border-color: var(--dark); color: var(--bg); }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
  .stat-box {
    background: var(--warm);
    border-radius: 12px;
    padding: 0.75rem 0.5rem;
    text-align: center;
  }
  .stat-box .s-val { font-family: 'DM Serif Display', serif; font-size: 1.4rem; color: var(--dark); }
  .stat-box .s-lbl { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-top: 0.1rem; }

  .month-history { margin-top: 1rem; }
  .month-row { display: flex; justify-content: space-between; align-items: center; padding: 0.45rem 0; border-bottom: 1px solid var(--warm); font-size: 0.85rem; }
  .month-row:last-child { border-bottom: none; }
  .month-name { font-weight: 500; color: var(--dark); }
  .month-stats { font-size: 0.78rem; color: var(--text-muted); }

  .new-route-btn {
    width: 100%;
    padding: 0.8rem;
    border-radius: 12px;
    border: 1.5px solid var(--mid);
    background: transparent;
    color: var(--dark);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    cursor: pointer;
    margin-top: 0.7rem;
    transition: all 0.18s;
  }
  .new-route-btn:hover { border-color: var(--dark); }

  .card.loading-state { text-align: center; padding: 2rem; display: none; }
  .walk-anim { font-size: 2rem; animation: walk 0.6s steps(2) infinite; }
  @keyframes walk { 0% { transform: translateX(-4px); } 100% { transform: translateX(4px); } }
  .loading-text { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--dark); margin-top: 0.75rem; }
  .loading-sub { font-size: 0.82rem; color: var(--text-muted); margin-top: 0.25rem; }

  @keyframes fadeDown { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
  <div class="logo">Walk <span>Buddy</span></div>
  <div class="tagline" id="tagline">Detecting your location‚Ä¶</div>
</header>

<!-- Theme switcher -->
<div class="theme-row">
  <button class="theme-btn forest active" onclick="setTheme('forest', this)" title="Forest"></button>
  <button class="theme-btn ocean"  onclick="setTheme('ocean', this)"  title="Ocean"></button>
  <button class="theme-btn city"   onclick="setTheme('city', this)"   title="City"></button>
  <button class="theme-btn bloom"  onclick="setTheme('bloom', this)"  title="Bloom"></button>
</div>

<!-- Weather + Streak -->
<div class="top-bar">
  <div class="top-pill" id="weather-pill">
    <span class="pill-icon">üå§Ô∏è</span>
    <span id="weather-text">‚Äî</span>
  </div>
  <div class="top-pill streak-pill" id="streak-pill">
    <span class="pill-icon">üî•</span>
    <div>
      <div id="streak-text">0 day streak</div>
      <div class="pill-sub" id="streak-sub">Go on a walk to start!</div>
    </div>
  </div>
</div>

<!-- Planner -->
<div class="card" id="planner-card">
  <div class="section-label">How far do you want to walk?</div>
  <div class="distance-display" id="dist-display">1.5 <span>miles</span></div>
  <input type="range" id="dist-slider" min="0.5" max="5" step="0.5" value="1.5">
  <div class="range-labels"><span>0.5 mi</span><span>5 mi</span></div>

  <div style="margin-top: 1.4rem;">
    <div class="section-label">What do you want to pass by?</div>
    <div class="prefs-grid">
      <button class="pref-chip" data-pref="park"       onclick="togglePref(this)"><span class="icon">üå≥</span> Park</button>
      <button class="pref-chip" data-pref="coffee"     onclick="togglePref(this)"><span class="icon">‚òï</span> Coffee</button>
      <button class="pref-chip" data-pref="bookstore"  onclick="togglePref(this)"><span class="icon">üìö</span> Bookstore</button>
      <button class="pref-chip" data-pref="shops"      onclick="togglePref(this)"><span class="icon">üõçÔ∏è</span> Shops</button>
      <button class="pref-chip" data-pref="restaurant" onclick="togglePref(this)"><span class="icon">üçú</span> Restaurant</button>
      <button class="pref-chip" data-pref="nature"     onclick="togglePref(this)"><span class="icon">üåø</span> Nature</button>
      <button class="pref-chip" data-pref="art"        onclick="togglePref(this)"><span class="icon">üé®</span> Art / Murals</button>
      <button class="pref-chip" data-pref="quiet"      onclick="togglePref(this)"><span class="icon">ü§´</span> Quiet streets</button>
    </div>
  </div>

  <button class="generate-btn" onclick="generateRoute()">üó∫Ô∏è Generate My Walk</button>
</div>

<!-- Loading -->
<div class="card loading-state" id="loading-card">
  <div class="walk-anim">üö∂</div>
  <div class="loading-text">Finding your route‚Ä¶</div>
  <div class="loading-sub">Discovering spots along the way</div>
</div>

<!-- Map + results -->
<div id="map-section">
  <div id="map"></div>
  <div class="route-info" id="route-info"></div>
  <div class="spots-list" id="spots-list" style="display:none"></div>
  <div class="streak-banner" id="streak-banner">
    <div class="streak-num" id="streak-banner-num"></div>
    <div class="streak-msg" id="streak-banner-msg"></div>
  </div>
  <button class="new-route-btn" onclick="resetPlanner()">‚Ü© Plan a different walk</button>
</div>

<!-- Stats -->
<div class="card stats-card" id="stats-card">
  <div class="stats-header">
    <div class="section-label" style="margin:0">Your Stats</div>
    <div class="stats-tabs">
      <button class="stats-tab active" onclick="showStats('month', this)">Month</button>
      <button class="stats-tab" onclick="showStats('year', this)">Year</button>
      <button class="stats-tab" onclick="showStats('history', this)">History</button>
    </div>
  </div>
  <div id="stats-content"></div>
</div>

<script>
const WEHOLOCENTER = { lat: 34.0900, lng: -118.3617 };
let userCenter = null;
let map, directionsService, directionsRenderer, placesService;
const selectedPrefs = new Set();

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(theme, btn) {
  document.body.setAttribute('data-theme', theme === 'forest' ? '' : theme);
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  try { localStorage.setItem('wb_theme', theme); } catch(e) {}
}
(function loadTheme() {
  try {
    const t = localStorage.getItem('wb_theme') || 'forest';
    if (t !== 'forest') document.body.setAttribute('data-theme', t);
    const btn = document.querySelector('.theme-btn.' + t);
    if (btn) { document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
  } catch(e) {}
})();

// ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStreak() {
  try { return JSON.parse(localStorage.getItem('wb_streak') || '{"count":0,"lastWalk":null}'); }
  catch(e) { return { count:0, lastWalk:null }; }
}
function recordWalk() {
  const today = new Date().toDateString();
  const data = getStreak();
  if (data.lastWalk === today) return data.count;
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  data.count = data.lastWalk === yesterday ? data.count + 1 : 1;
  data.lastWalk = today;
  try { localStorage.setItem('wb_streak', JSON.stringify(data)); } catch(e) {}
  return data.count;
}
function updateStreakUI() {
  const data = getStreak();
  document.getElementById('streak-text').textContent = `${data.count} day streak`;
  const pill = document.getElementById('streak-pill');
  const sub = document.getElementById('streak-sub');
  if (data.count >= 1) {
    sub.textContent = data.count >= 7 ? 'üèÜ 7 day goal reached!' : `${7-(data.count%7)} days to next milestone`;
    pill.classList.add('active');
  } else {
    sub.textContent = 'Go on a walk to start!';
    pill.classList.remove('active');
  }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWalkLog() {
  try { return JSON.parse(localStorage.getItem('wb_walklog') || '[]'); }
  catch(e) { return []; }
}
function logWalkStats(miles) {
  const log = getWalkLog();
  const now = new Date();
  log.push({ date: now.toISOString(), miles: parseFloat(miles), steps: Math.round(miles * 2000), month: now.getMonth(), year: now.getFullYear() });
  try { localStorage.setItem('wb_walklog', JSON.stringify(log)); } catch(e) {}
}

const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function showStats(view, btn) {
  document.querySelectorAll('.stats-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const log = getWalkLog();
  const now = new Date();
  const content = document.getElementById('stats-content');

  if (view === 'month') {
    const thisMonth = log.filter(w => w.month === now.getMonth() && w.year === now.getFullYear());
    const miles = thisMonth.reduce((a,w) => a + w.miles, 0).toFixed(1);
    const steps = thisMonth.reduce((a,w) => a + w.steps, 0).toLocaleString();
    const walks = thisMonth.length;
    content.innerHTML = `
      <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">${MONTHS[now.getMonth()]} ${now.getFullYear()}</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="s-val">${walks}</div><div class="s-lbl">Walks</div></div>
        <div class="stat-box"><div class="s-val">${miles}</div><div class="s-lbl">Miles</div></div>
        <div class="stat-box"><div class="s-val">${steps}</div><div class="s-lbl">Steps</div></div>
      </div>`;
  } else if (view === 'year') {
    const thisYear = log.filter(w => w.year === now.getFullYear());
    const miles = thisYear.reduce((a,w) => a + w.miles, 0).toFixed(1);
    const steps = thisYear.reduce((a,w) => a + w.steps, 0).toLocaleString();
    const walks = thisYear.length;
    content.innerHTML = `
      <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">${now.getFullYear()} Total</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="s-val">${walks}</div><div class="s-lbl">Walks</div></div>
        <div class="stat-box"><div class="s-val">${miles}</div><div class="s-lbl">Miles</div></div>
        <div class="stat-box"><div class="s-val">${steps}</div><div class="s-lbl">Steps</div></div>
      </div>`;
  } else {
    // Group by month
    const grouped = {};
    log.forEach(w => {
      const key = `${w.year}-${w.month}`;
      if (!grouped[key]) grouped[key] = { month: w.month, year: w.year, miles: 0, steps: 0, walks: 0 };
      grouped[key].miles += w.miles;
      grouped[key].steps += w.steps;
      grouped[key].walks++;
    });
    const sorted = Object.values(grouped).sort((a,b) => b.year - a.year || b.month - a.month);
    if (sorted.length === 0) {
      content.innerHTML = `<div style="text-align:center;color:var(--text-muted);padding:1rem;font-size:0.85rem">No walks yet ‚Äî go explore!</div>`;
    } else {
      content.innerHTML = `<div class="month-history">${sorted.map(g => `
        <div class="month-row">
          <div class="month-name">${MONTHS[g.month]} ${g.year}</div>
          <div class="month-stats">${g.walks} walks ¬∑ ${g.miles.toFixed(1)} mi ¬∑ ${g.steps.toLocaleString()} steps</div>
        </div>`).join('')}</div>`;
    }
  }
}

// ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWeather(lat, lng) {
  try {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=fahrenheit`);
    const data = await res.json();
    document.getElementById('weather-pill').querySelector('.pill-icon').textContent = weatherIcon(data.current_weather.weathercode);
    document.getElementById('weather-text').textContent = `${Math.round(data.current_weather.temperature)}¬∞F`;
  } catch(e) {}
}
function weatherIcon(c) {
  if (c===0) return '‚òÄÔ∏è'; if (c<=2) return 'üå§Ô∏è'; if (c===3) return '‚òÅÔ∏è';
  if (c<=49) return 'üå´Ô∏è'; if (c<=67) return 'üåßÔ∏è'; if (c<=77) return '‚ùÑÔ∏è';
  if (c<=82) return 'üå¶Ô∏è'; return '‚õàÔ∏è';
}

// ‚îÄ‚îÄ CITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function detectCity(lat, lng) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data = await res.json();
    const city = data.address.city || data.address.town || data.address.village || data.address.county || 'Your neighborhood';
    document.getElementById('tagline').textContent = `${city} ¬∑ Discover your neighborhood`;
  } catch(e) { document.getElementById('tagline').textContent = 'Discover your neighborhood'; }
}

// ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePref(el) {
  const p = el.dataset.pref;
  if (selectedPrefs.has(p)) { selectedPrefs.delete(p); el.classList.remove('active'); }
  else { selectedPrefs.add(p); el.classList.add('active'); }
}
const prefToType = { park:'park', coffee:'cafe', bookstore:'book_store', shops:'clothing_store', restaurant:'restaurant', nature:'park', art:'art_gallery', quiet:null };
const prefEmoji  = { park:'üå≥', coffee:'‚òï', bookstore:'üìö', shops:'üõçÔ∏è', restaurant:'üçú', nature:'üåø', art:'üé®', quiet:'ü§´' };

// ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const slider = document.getElementById('dist-slider');
const display = document.getElementById('dist-display');
slider.addEventListener('input', () => {
  display.innerHTML = `${slider.value} <span>miles</span>`;
  slider.style.setProperty('--pct', ((slider.value-slider.min)/(slider.max-slider.min))*100+'%');
});
slider.style.setProperty('--pct', '22.2%');

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: WEHOLOCENTER, zoom: 14,
    styles: [
      { featureType:'all', elementType:'geometry', stylers:[{color:'#f5efe6'}] },
      { featureType:'road', elementType:'geometry', stylers:[{color:'#ede0cc'}] },
      { featureType:'road.arterial', elementType:'geometry', stylers:[{color:'#d4c5a9'}] },
      { featureType:'water', elementType:'geometry', stylers:[{color:'#a8cfe0'}] },
      { featureType:'poi.park', elementType:'geometry', stylers:[{color:'#c8dfc4'}] },
      { featureType:'poi', elementType:'labels', stylers:[{visibility:'off'}] },
      { featureType:'transit', stylers:[{visibility:'off'}] },
    ],
    disableDefaultUI: true, zoomControl: true,
  });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    polylineOptions: { strokeColor:'#3D2B1F', strokeWeight:4, strokeOpacity:0.85 },
    suppressMarkers: false,
  });
  directionsRenderer.setMap(map);
  placesService = new google.maps.places.PlacesService(map);

  updateStreakUI();
  showStats('month', document.querySelector('.stats-tab.active'));

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userCenter = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(userCenter);
        new google.maps.Marker({
          position: userCenter, map,
          icon: { path:google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#7BADC4', fillOpacity:1, strokeColor:'white', strokeWeight:2 },
          title: 'You are here',
        });
        detectCity(userCenter.lat, userCenter.lng);
        fetchWeather(userCenter.lat, userCenter.lng);
      },
      () => {
        document.getElementById('tagline').textContent = 'West Hollywood ¬∑ Discover your neighborhood';
        fetchWeather(WEHOLOCENTER.lat, WEHOLOCENTER.lng);
      }
    );
  } else {
    document.getElementById('tagline').textContent = 'West Hollywood ¬∑ Discover your neighborhood';
    fetchWeather(WEHOLOCENTER.lat, WEHOLOCENTER.lng);
  }
}

// ‚îÄ‚îÄ GENERATE ROUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateRoute() {
  const miles = parseFloat(slider.value);
  const center = userCenter || WEHOLOCENTER;

  document.getElementById('planner-card').style.display = 'none';
  document.getElementById('loading-card').style.display = 'block';
  document.getElementById('map-section').style.display = 'none';

  const waypoints = [], foundSpots = [];
  const types = [...selectedPrefs].map(p => prefToType[p]).filter(Boolean);
  const uniqueTypes = [...new Set(types)];
  const angles = [0, 90, 180, 270, 45, 135, 225, 315];
  let angleIdx = 0;
  const metersPerMile = 1609.34;
  const radius = (miles / 3) * metersPerMile;

  await Promise.all(uniqueTypes.slice(0,3).map((type) => new Promise(resolve => {
    const angle = (angles[angleIdx++ % angles.length] * Math.PI) / 180;
    const offsetLat = center.lat + (radius/111320)*0.5*Math.sin(angle);
    const offsetLng = center.lng + (radius/(111320*Math.cos(center.lat*Math.PI/180)))*0.5*Math.cos(angle);
    placesService.nearbySearch({ location:{lat:offsetLat,lng:offsetLng}, radius, type }, (results, status) => {
      if (status==='OK' && results.length>0) {
        const pick = results[Math.floor(Math.random()*Math.min(5,results.length))];
        waypoints.push({ location:{lat:pick.geometry.location.lat(),lng:pick.geometry.location.lng()}, stopover:false });
        foundSpots.push({ name:pick.name, type:[...selectedPrefs].find(p=>prefToType[p]===type), placeId:pick.place_id });
      }
      resolve();
    });
  })));

  if (waypoints.length===0) {
    const angle = Math.random()*2*Math.PI;
    const d = (miles/4)*metersPerMile;
    waypoints.push({ location:{ lat:center.lat+(d/111320)*Math.sin(angle), lng:center.lng+(d/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle) }, stopover:false });
  }

  directionsService.route({
    origin:center, destination:center, waypoints,
    travelMode:'WALKING', optimizeWaypoints:true,
    avoidHighways:true, avoidTolls:true,
  }, (result, status) => {
    document.getElementById('loading-card').style.display = 'none';

    if (status==='OK') {
      directionsRenderer.setDirections(result);
      const leg = result.routes[0].legs;
      let totalDist=0, totalTime=0;
      leg.forEach(l => { totalDist+=l.distance.value; totalTime+=l.duration.value; });
      const distMiles = (totalDist/1609.34).toFixed(1);
      const timeMin = Math.round(totalTime/60);

      document.getElementById('route-info').innerHTML = `
        <div class="info-pill"><div class="val">${distMiles}</div><div class="lbl">Miles</div></div>
        <div class="info-pill"><div class="val">${timeMin}</div><div class="lbl">Est. Min</div></div>
        <div class="info-pill"><div class="val">${Math.round(distMiles*2000)}</div><div class="lbl">Est. Steps</div></div>
      `;

      const spotsList = document.getElementById('spots-list');
      if (foundSpots.length>0) {
        spotsList.innerHTML = `<div class="spots-title">Along your route</div>${foundSpots.map(s => `
          <a class="spot-item" href="https://www.google.com/maps/place/?q=place_id:${s.placeId}" target="_blank" rel="noopener">
            <div class="spot-icon">${prefEmoji[s.type]||'üìç'}</div>
            <div>
              <div class="spot-name">${s.name}</div>
              <div class="spot-type">${s.type ? s.type.charAt(0).toUpperCase()+s.type.slice(1) : 'Point of interest'}</div>
            </div>
            <div class="spot-arrow">‚Üó</div>
          </a>`).join('')}`;
        spotsList.style.display = 'block';
      } else {
        spotsList.style.display = 'none';
      }

      // Log stats
      logWalkStats(distMiles);
      showStats('month', document.querySelector('.stats-tab.active'));

      // Streak
      const newStreak = recordWalk();
      updateStreakUI();
      const banner = document.getElementById('streak-banner');
      document.getElementById('streak-banner-num').textContent = `üî• ${newStreak} Day Streak!`;
      const msgs = {1:"You started your streak ‚Äî come back tomorrow!", 7:"üèÜ 7 days! You absolutely crushed it!"};
      document.getElementById('streak-banner-msg').textContent = msgs[newStreak] || (newStreak%7===0 ? `${newStreak} days strong. Incredible!` : `Keep it up ‚Äî ${7-(newStreak%7)} days to your next milestone!`);
      banner.style.display = 'block';

      document.getElementById('map-section').style.display = 'block';
    } else {
      document.getElementById('map-section').style.display = 'block';
      document.getElementById('route-info').innerHTML = `<div class="info-pill" style="flex:1"><div class="val">üó∫Ô∏è</div><div class="lbl">Route unavailable ‚Äî try different prefs</div></div>`;
      document.getElementById('spots-list').style.display = 'none';
      document.getElementById('streak-banner').style.display = 'none';
    }
  });
}

function resetPlanner() {
  document.getElementById('map-section').style.display = 'none';
  document.getElementById('planner-card').style.display = 'block';
}
</script>

<!-- Replace AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc with your Google Maps API key -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc&libraries=places&callback=initMap">
</script>

</body>
</html>
