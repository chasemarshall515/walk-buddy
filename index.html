<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walk Buddy</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root { --primary:#8FAF8C; --bg:#F7F3EC; --dark:#3D2B1F; --mid:#D4C5A9; --accent:#7BADC4; --warm:#E8D5B7; --card:#ffffff; --text-sub:#7a6355; --text-muted:#9a8878; }
  [data-theme="ocean"] { --primary:#5B9EC9; --bg:#EEF5FA; --dark:#1A3A4A; --mid:#B8D4E8; --accent:#F4A261; --warm:#D6EAF5; --card:#ffffff; --text-sub:#3a6070; --text-muted:#7a9aaa; }
  [data-theme="city"]  { --primary:#A0A0A0; --bg:#1A1A1A; --dark:#F0F0F0; --mid:#333333; --accent:#E8C547; --warm:#2A2A2A; --card:#242424; --text-sub:#A0A0A0; --text-muted:#707070; }
  [data-theme="bloom"] { --primary:#C77DBA; --bg:#FDF0F8; --dark:#3D1A35; --mid:#E8C5DF; --accent:#F4A261; --warm:#F5E0F0; --card:#ffffff; --text-sub:#7a3a6a; --text-muted:#9a6a8a; }

  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--dark); min-height:100vh; overflow-x:hidden; transition:background 0.4s,color 0.4s; }
  body::before { content:''; position:fixed; top:-120px; right:-120px; width:400px; height:400px; border-radius:50%; background:radial-gradient(circle,var(--primary) 0%,transparent 70%); opacity:0.2; pointer-events:none; }
  body::after  { content:''; position:fixed; bottom:-80px; left:-80px; width:300px; height:300px; border-radius:50%; background:radial-gradient(circle,var(--accent) 0%,transparent 70%); opacity:0.15; pointer-events:none; }

  header { padding:1.25rem 1rem 0.25rem; text-align:center; position:relative; }
  .logo { font-family:'DM Serif Display',serif; font-size:2.4rem; color:var(--dark); letter-spacing:-0.5px; }
  .logo span { color:var(--primary); font-style:italic; }
  .tagline { font-size:0.78rem; font-weight:300; color:var(--text-sub); margin-top:0.2rem; letter-spacing:0.08em; text-transform:uppercase; }
  .theme-dropdown-wrap { position:absolute; top:1rem; right:0.75rem; z-index:100; }
  .theme-select { appearance:none; -webkit-appearance:none; background:var(--card); color:var(--dark); border:1.5px solid var(--mid); border-radius:100px; padding:0.25rem 1.6rem 0.25rem 0.6rem; font-size:0.7rem; font-family:'DM Sans',sans-serif; font-weight:500; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.07); background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 0.5rem center; }
  .theme-select:focus { outline:none; border-color:var(--primary); }

  .top-bar { display:flex; justify-content:center; gap:0.5rem; padding:0.4rem 1rem 0.5rem; max-width:480px; margin:0 auto; }
  .top-pill { display:flex; align-items:center; gap:0.35rem; background:var(--card); border-radius:100px; padding:0.35rem 0.75rem; font-size:0.78rem; font-weight:500; color:var(--dark); box-shadow:0 2px 10px rgba(0,0,0,0.07); transition:background 0.4s,color 0.4s; }
  .top-pill .pill-sub { font-size:0.64rem; color:var(--text-muted); font-weight:400; }
  .streak-pill.active { background:var(--dark); color:var(--bg); }
  .streak-pill.active .pill-sub { color:var(--mid); }

  .card { background:var(--card); border-radius:20px; padding:1.5rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 24px rgba(0,0,0,0.06); transition:background 0.4s; }
  .section-label { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.12em; color:var(--primary); margin-bottom:0.65rem; }
  .distance-display { font-family:'DM Serif Display',serif; font-size:3rem; color:var(--dark); line-height:1; margin-bottom:0.2rem; }
  .distance-display span { font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:300; color:var(--text-sub); }
  input[type=range] { -webkit-appearance:none; width:100%; height:6px; border-radius:3px; background:linear-gradient(to right,var(--primary) 0%,var(--primary) var(--pct,30%),var(--mid) var(--pct,30%),var(--mid) 100%); margin:0.8rem 0 0.35rem; outline:none; cursor:pointer; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:var(--dark); border:3px solid var(--card); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
  .range-labels { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-muted); }
  .prefs-grid { display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.35rem; }
  .pref-chip { display:flex; align-items:center; gap:0.35rem; padding:0.4rem 0.85rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; cursor:pointer; font-size:0.8rem; font-family:'DM Sans',sans-serif; color:var(--dark); transition:all 0.18s; -webkit-tap-highlight-color:transparent; }
  .pref-chip:active { transform:scale(0.96); }
  .pref-chip.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }
  .generate-btn { width:100%; padding:0.9rem; border-radius:14px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.15rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-top:1.1rem; -webkit-tap-highlight-color:transparent; }
  .generate-btn:active { opacity:0.8; }

  /* THE MAP IS ALWAYS IN THE DOM AND ALWAYS VISIBLE AT CORRECT SIZE */
  /* We only show/hide the overlay panels on top */
  .map-wrap { max-width:480px; margin:0.5rem auto; padding:0 0.5rem; }
  #main-map { width:100%; height:360px; border-radius:18px; overflow:hidden; box-shadow:0 4px 24px rgba(0,0,0,0.1); }

  /* Loading overlay on top of map */
  .map-overlay { max-width:480px; margin:0 auto; padding:0 0.5rem; }
  .loading-box { background:var(--card); border-radius:16px; padding:1.5rem; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.08); display:none; margin-bottom:0.5rem; }
  .walk-anim { font-size:1.8rem; animation:walkstep 0.6s steps(2) infinite; display:inline-block; }
  @keyframes walkstep { 0%{transform:translateX(-4px)} 100%{transform:translateX(4px)} }
  .loading-text { font-family:'DM Serif Display',serif; font-size:1rem; color:var(--dark); margin-top:0.6rem; }
  .loading-sub { font-size:0.78rem; color:var(--text-muted); margin-top:0.2rem; }

  /* Route info */
  .route-info { display:none; flex-direction:column; gap:0.5rem; margin-bottom:0.5rem; }
  .route-pills { display:flex; gap:0.5rem; }
  .info-pill { flex:1; background:var(--card); border-radius:12px; padding:0.7rem 0.5rem; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .info-pill .val { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); }
  .info-pill .lbl { font-size:0.64rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); margin-top:0.1rem; }
  .spots-list { background:var(--card); border-radius:14px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:none; }
  .spots-title { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.1em; color:var(--primary); margin-bottom:0.65rem; }
  .spot-item { display:flex; align-items:center; gap:0.65rem; padding:0.4rem 0; border-bottom:1px solid var(--warm); font-size:0.85rem; color:var(--dark); }
  .spot-item:last-child { border-bottom:none; }
  .spot-icon { width:28px; height:28px; border-radius:7px; background:var(--warm); display:flex; align-items:center; justify-content:center; font-size:0.9rem; flex-shrink:0; }
  .spot-name { font-weight:500; }
  .spot-type { font-size:0.72rem; color:var(--text-muted); }

  /* Ready card */
  .ready-card { background:var(--card); border-radius:20px; padding:1.4rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 20px rgba(0,0,0,0.06); text-align:center; display:none; }
  .ready-title { font-family:'DM Serif Display',serif; font-size:1.5rem; color:var(--dark); margin-bottom:0.35rem; }
  .ready-sub { font-size:0.82rem; color:var(--text-muted); margin-bottom:1.1rem; }
  .ready-btns { display:flex; gap:0.65rem; }
  .ready-yes { flex:1; padding:0.8rem; border-radius:12px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.05rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .ready-no  { flex:1; padding:0.8rem; border-radius:12px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.88rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }

  /* Nav turn banner */
  .turn-banner { background:var(--dark); color:var(--bg); border-radius:14px; padding:0.75rem 1rem; margin-bottom:0.5rem; display:none; align-items:center; gap:0.75rem; box-shadow:0 4px 16px rgba(0,0,0,0.2); max-width:480px; margin-left:auto; margin-right:auto; }
  .turn-arrow { font-size:1.5rem; flex-shrink:0; min-width:2rem; text-align:center; }
  .turn-text { flex:1; }
  .turn-instruction { font-size:0.9rem; font-weight:500; line-height:1.35; }
  .turn-dist { font-size:0.7rem; opacity:0.6; margin-top:0.1rem; }
  .turn-timer { font-size:0.75rem; opacity:0.5; flex-shrink:0; font-variant-numeric:tabular-nums; }

  /* Nav stats */
  .nav-stats-wrap { display:none; flex-direction:column; gap:0.5rem; max-width:480px; margin:0 auto; padding:0 0.5rem; }
  .nav-progress-wrap { background:var(--mid); border-radius:100px; height:6px; overflow:hidden; }
  .nav-progress-bar { height:100%; border-radius:100px; background:var(--primary); transition:width 0.8s ease; width:0%; }
  .nav-stats { display:flex; gap:0.5rem; }
  .ns { flex:1; background:var(--card); border-radius:12px; padding:0.6rem 0.4rem; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
  .ns .nv { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--dark); }
  .ns .nl { font-size:0.6rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.1rem; }
  .walk-actions { display:flex; gap:0.5rem; }
  .pause-btn { flex:1; padding:0.7rem; border-radius:11px; border:1.5px solid var(--mid); background:var(--card); color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .cancel-btn { flex:1; padding:0.7rem; border-radius:11px; border:1.5px solid rgba(200,80,80,0.3); background:var(--card); color:#c85050; font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .complete-btn { width:100%; padding:0.85rem; border-radius:12px; border:none; background:var(--primary); color:var(--dark); font-family:'DM Serif Display',serif; font-size:1.1rem; cursor:pointer; opacity:0.3; transition:opacity 0.3s; -webkit-tap-highlight-color:transparent; }
  .complete-btn.unlocked { opacity:1; }
  .complete-hint { font-size:0.7rem; color:var(--text-muted); text-align:center; }

  /* Streak banner */
  .streak-banner { background:var(--dark); color:var(--bg); border-radius:16px; padding:1rem 1.2rem; margin:0.5rem auto; max-width:480px; text-align:center; display:none; box-shadow:0 4px 16px rgba(0,0,0,0.12); }
  .streak-num { font-family:'DM Serif Display',serif; font-size:1.6rem; }
  .streak-msg { font-size:0.78rem; color:var(--mid); margin-top:0.2rem; }

  /* Stats */
  .stats-card { margin-bottom:2rem; }
  .stats-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.9rem; }
  .stats-tabs { display:flex; gap:0.35rem; }
  .stats-tab { padding:0.28rem 0.7rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; font-size:0.72rem; font-family:'DM Sans',sans-serif; color:var(--dark); cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .stats-tab.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }
  .stats-big { display:flex; gap:0.5rem; margin-bottom:0.6rem; }
  .sbb { flex:1; background:var(--warm); border-radius:14px; padding:0.9rem 0.7rem; text-align:center; }
  .sbb .sv { font-family:'DM Serif Display',serif; font-size:1.8rem; color:var(--dark); line-height:1; }
  .sbb .sl { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.25rem; }
  .stats-small { display:flex; gap:0.5rem; }
  .ssb { flex:1; background:var(--warm); border-radius:11px; padding:0.65rem 0.5rem; text-align:center; }
  .ssb .sv { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--dark); }
  .ssb .sl { font-size:0.6rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); margin-top:0.1rem; }
  .month-history { margin-top:0.7rem; }
  .month-row { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--warm); }
  .month-row:last-child { border-bottom:none; }
  .month-name { font-weight:500; font-size:0.85rem; }
  .month-right { text-align:right; }
  .month-miles { font-family:'DM Serif Display',serif; font-size:0.95rem; }
  .month-detail { font-size:0.7rem; color:var(--text-muted); }
  .stats-empty { text-align:center; color:var(--text-muted); padding:1.5rem 0; font-size:0.82rem; }
  .new-route-btn { width:100%; padding:0.75rem; border-radius:11px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.86rem; cursor:pointer; margin:0.5rem auto; display:block; max-width:480px; -webkit-tap-highlight-color:transparent; }

  @keyframes fadeDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<header>
  <div class="logo">Walk <span>Buddy</span></div>
  <div class="tagline" id="tagline">Detecting your location‚Ä¶</div>
  <div class="theme-dropdown-wrap">
    <select class="theme-select" id="theme-select" onchange="setTheme(this.value)">
      <option value="forest">üåø Forest</option>
      <option value="ocean">üåä Ocean</option>
      <option value="city">üåÜ City</option>
      <option value="bloom">üå∏ Bloom</option>
    </select>
  </div>
</header>

<div class="top-bar">
  <div class="top-pill" id="weather-pill"><span class="pill-icon">üå§Ô∏è</span><span id="weather-text">‚Äî</span></div>
  <div class="top-pill streak-pill" id="streak-pill">
    <span class="pill-icon">üî•</span>
    <div><div id="streak-text">0 day streak</div><div class="pill-sub" id="streak-sub">Go on a walk to start!</div></div>
  </div>
</div>

<!-- Planner -->
<div class="card" id="planner-card">
  <div class="section-label">How far do you want to walk?</div>
  <div class="distance-display" id="dist-display">1.5 <span>miles</span></div>
  <input type="range" id="dist-slider" min="0.5" max="5" step="0.5" value="1.5">
  <div class="range-labels"><span>0.5 mi</span><span>5 mi</span></div>
  <div style="margin-top:1.2rem">
    <div class="section-label">What do you want to pass by?</div>
    <div class="prefs-grid">
      <button class="pref-chip" data-pref="park"       onclick="togglePref(this)"><span class="icon">üå≥</span> Park</button>
      <button class="pref-chip" data-pref="coffee"     onclick="togglePref(this)"><span class="icon">‚òï</span> Coffee</button>
      <button class="pref-chip" data-pref="bookstore"  onclick="togglePref(this)"><span class="icon">üìö</span> Bookstore</button>
      <button class="pref-chip" data-pref="shops"      onclick="togglePref(this)"><span class="icon">üõçÔ∏è</span> Shops</button>
      <button class="pref-chip" data-pref="restaurant" onclick="togglePref(this)"><span class="icon">üçú</span> Restaurant</button>
      <button class="pref-chip" data-pref="nature"     onclick="togglePref(this)"><span class="icon">üåø</span> Nature</button>
      <button class="pref-chip" data-pref="art"        onclick="togglePref(this)"><span class="icon">üé®</span> Art / Murals</button>
      <button class="pref-chip" data-pref="water"      onclick="togglePref(this)"><span class="icon">üåä</span> Water</button>
      <button class="pref-chip" data-pref="quiet"      onclick="togglePref(this)"><span class="icon">ü§´</span> Quiet streets</button>
    </div>
  </div>
  <button class="generate-btn" onclick="generateRoute()">üó∫Ô∏è Generate My Walk</button>
</div>

<!-- MAP - always in DOM, always has real dimensions so Google Maps initializes properly -->
<div class="map-wrap">
  <div id="main-map"></div>
</div>

<!-- Turn-by-turn banner (shown during walk) -->
<div class="turn-banner" id="turn-banner">
  <div class="turn-arrow" id="turn-arrow">‚Üë</div>
  <div class="turn-text">
    <div class="turn-instruction" id="turn-instruction">Follow the route</div>
    <div class="turn-dist" id="turn-dist"></div>
  </div>
  <div class="turn-timer" id="nav-timer">0:00</div>
</div>

<!-- Route info (shown after generation) -->
<div class="route-info map-overlay" id="route-info-wrap">
  <div class="route-pills" id="route-pills"></div>
  <div class="spots-list" id="spots-list"></div>
</div>

<!-- Loading -->
<div class="map-overlay">
  <div class="loading-box" id="loading-box">
    <div class="walk-anim">üö∂</div>
    <div class="loading-text">Finding your route‚Ä¶</div>
    <div class="loading-sub">Discovering spots along the way</div>
  </div>
</div>

<!-- Ready to walk -->
<div class="ready-card" id="ready-card">
  <div class="ready-title">Ready to walk? üö∂</div>
  <div class="ready-sub" id="ready-sub">Your route is set. Let's go!</div>
  <div class="ready-btns">
    <button class="ready-yes" onclick="startWalking()">Yes, let's go!</button>
    <button class="ready-no"  onclick="resetPlanner()">Not now</button>
  </div>
</div>

<!-- Nav stats (shown during walk) -->
<div class="nav-stats-wrap" id="nav-stats-wrap">
  <div class="nav-progress-wrap"><div class="nav-progress-bar" id="nav-progress"></div></div>
  <div class="nav-stats">
    <div class="ns"><div class="nv" id="n-dist">0.00</div><div class="nl">Miles</div></div>
    <div class="ns"><div class="nv" id="n-steps">0</div><div class="nl">Steps</div></div>
    <div class="ns"><div class="nv" id="n-pct">0%</div><div class="nl">Done</div></div>
    <div class="ns"><div class="nv" id="n-time">0:00</div><div class="nl">Time</div></div>
  </div>
  <div class="walk-actions">
    <button class="pause-btn" id="pause-btn" onclick="togglePause()">‚è∏ Pause</button>
    <button class="cancel-btn" onclick="cancelWalk()">‚úï Cancel</button>
  </div>
  <button class="complete-btn" id="complete-btn" onclick="completeWalk()" disabled>Complete Walk ‚úÖ</button>
  <div class="complete-hint" id="complete-hint">Walk 65% of your route to unlock</div>
</div>

<!-- Streak banner -->
<div class="streak-banner" id="streak-banner">
  <div class="streak-num" id="streak-banner-num"></div>
  <div class="streak-msg" id="streak-banner-msg"></div>
</div>

<!-- Stats -->
<div class="card stats-card" id="stats-card">
  <div class="stats-header">
    <div class="section-label" style="margin:0">Your Stats</div>
    <div class="stats-tabs">
      <button class="stats-tab active" onclick="showStats('month',this)">Month</button>
      <button class="stats-tab" onclick="showStats('year',this)">Year</button>
      <button class="stats-tab" onclick="showStats('history',this)">History</button>
    </div>
  </div>
  <div id="stats-content"></div>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WEHOLOCENTER = {lat:34.0900, lng:-118.3617};
const prefToType = {park:'park',coffee:'cafe',bookstore:'book_store',shops:'clothing_store',restaurant:'restaurant',nature:'park',art:'art_gallery',water:'natural_feature',quiet:null};
const prefEmoji  = {park:'üå≥',coffee:'‚òï',bookstore:'üìö',shops:'üõçÔ∏è',restaurant:'üçú',nature:'üåø',art:'üé®',water:'üåä',quiet:'ü§´'};
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userCenter = null;
let map, directionsService, directionsRenderer, placesService;
let actualRouteMiles = 0, requestedMiles = 1.5;
let allSteps = [], currentStepIndex = 0;
let lastDirectionsResult = null;
const selectedPrefs = new Set();

// Walk tracking
let walkDistanceMiles = 0, walkStartTime = null;
let walkTimerInterval = null, geoWatchId = null;
let lastGeoPos = null, isPaused = false, walkUnlocked = false;
let userMarker = null, walkedPath = null;
let isWalking = false;

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(t) {
  document.body.setAttribute('data-theme', t === 'forest' ? '' : t);
  try { localStorage.setItem('wb_theme', t); } catch(e) {}
}
(function() {
  try {
    const t = localStorage.getItem('wb_theme') || 'forest';
    document.body.setAttribute('data-theme', t === 'forest' ? '' : t);
    const s = document.getElementById('theme-select');
    if (s) s.value = t;
  } catch(e) {}
})();

// ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStreak() {
  try { return JSON.parse(localStorage.getItem('wb_streak') || '{"count":0,"lastWalk":null}'); }
  catch(e) { return {count:0, lastWalk:null}; }
}
function recordWalk() {
  const today = new Date().toDateString();
  const d = getStreak();
  if (d.lastWalk === today) return d.count;
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  d.count = d.lastWalk === yesterday ? d.count + 1 : 1;
  d.lastWalk = today;
  try { localStorage.setItem('wb_streak', JSON.stringify(d)); } catch(e) {}
  return d.count;
}
function updateStreakUI() {
  const d = getStreak();
  document.getElementById('streak-text').textContent = `${d.count} day streak`;
  const pill = document.getElementById('streak-pill');
  const sub  = document.getElementById('streak-sub');
  if (d.count >= 1) {
    sub.textContent = d.count >= 7 ? 'üèÜ 7 day goal reached!' : `${7-(d.count%7)} days to next milestone`;
    pill.classList.add('active');
  } else {
    sub.textContent = 'Go on a walk to start!';
    pill.classList.remove('active');
  }
}

// ‚îÄ‚îÄ WALK LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWalkLog() { try { return JSON.parse(localStorage.getItem('wb_walklog') || '[]'); } catch(e) { return []; } }
function logWalkStats(miles) {
  const log = getWalkLog(), now = new Date();
  log.push({date:now.toISOString(), miles:parseFloat(miles), steps:Math.round(miles*2000), month:now.getMonth(), year:now.getFullYear()});
  try { localStorage.setItem('wb_walklog', JSON.stringify(log)); } catch(e) {}
}
function showStats(view, btn) {
  document.querySelectorAll('.stats-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const log = getWalkLog(), now = new Date(), c = document.getElementById('stats-content');
  if (view === 'month') {
    const w = log.filter(x => x.month === now.getMonth() && x.year === now.getFullYear());
    const miles = w.reduce((a,x) => a+x.miles, 0).toFixed(1), steps = w.reduce((a,x) => a+x.steps, 0);
    c.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${MONTHS[now.getMonth()]} ${now.getFullYear()}</div>
    <div class="stats-big"><div class="sbb"><div class="sv">${miles}</div><div class="sl">Miles this month</div></div><div class="sbb"><div class="sv">${w.length}</div><div class="sl">Walks this month</div></div></div>
    <div class="stats-small" style="margin-top:0.5rem"><div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div><div class="ssb"><div class="sv">${w.length>0?(miles/w.length).toFixed(1):'‚Äî'}</div><div class="sl">Avg mi/walk</div></div></div>`;
  } else if (view === 'year') {
    const w = log.filter(x => x.year === now.getFullYear());
    const miles = w.reduce((a,x) => a+x.miles, 0).toFixed(1), steps = w.reduce((a,x) => a+x.steps, 0);
    c.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${now.getFullYear()} Total</div>
    <div class="stats-big"><div class="sbb"><div class="sv">${miles}</div><div class="sl">Miles this year</div></div><div class="sbb"><div class="sv">${w.length}</div><div class="sl">Total walks</div></div></div>
    <div class="stats-small" style="margin-top:0.5rem"><div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div><div class="ssb"><div class="sv">${w.length>0?(miles/w.length).toFixed(1):'‚Äî'}</div><div class="sl">Avg mi/walk</div></div></div>`;
  } else {
    const grouped = {};
    log.forEach(x => { const k=`${x.year}-${x.month}`; if(!grouped[k]) grouped[k]={month:x.month,year:x.year,miles:0,steps:0,walks:0}; grouped[k].miles+=x.miles; grouped[k].steps+=x.steps; grouped[k].walks++; });
    const sorted = Object.values(grouped).sort((a,b) => b.year-a.year || b.month-a.month);
    c.innerHTML = sorted.length === 0
      ? `<div class="stats-empty">No walks yet ‚Äî go explore! üó∫Ô∏è</div>`
      : `<div class="month-history">${sorted.map(g=>`<div class="month-row"><div class="month-name">${MONTHS[g.month]} ${g.year}</div><div class="month-right"><div class="month-miles">${g.miles.toFixed(1)} mi</div><div class="month-detail">${g.walks} walks ¬∑ ${g.steps.toLocaleString()} steps</div></div></div>`).join('')}</div>`;
  }
}

// ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWeather(lat, lng) {
  try {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=fahrenheit`);
    const d = await r.json();
    document.getElementById('weather-pill').querySelector('.pill-icon').textContent = weatherIcon(d.current_weather.weathercode);
    document.getElementById('weather-text').textContent = `${Math.round(d.current_weather.temperature)}¬∞F`;
  } catch(e) {}
}
function weatherIcon(c) { if(c===0)return'‚òÄÔ∏è'; if(c<=2)return'üå§Ô∏è'; if(c===3)return'‚òÅÔ∏è'; if(c<=49)return'üå´Ô∏è'; if(c<=67)return'üåßÔ∏è'; if(c<=77)return'‚ùÑÔ∏è'; if(c<=82)return'üå¶Ô∏è'; return'‚õàÔ∏è'; }

// ‚îÄ‚îÄ CITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectCity(lat, lng) {
  try {
    // Use reverse geocoding via fetch to avoid Geocoder API dependency
    fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${getApiKey()}`)
      .then(r => r.json())
      .then(d => {
        if (d.status === 'OK' && d.results.length > 0) {
          const addr = d.results[0].address_components;
          const city = addr.find(a => a.types.includes('locality'))
                    || addr.find(a => a.types.includes('sublocality'))
                    || addr.find(a => a.types.includes('administrative_area_level_2'));
          document.getElementById('tagline').textContent = city
            ? `${city.long_name} ¬∑ Discover your neighborhood`
            : 'Discover your neighborhood';
        }
      }).catch(() => { document.getElementById('tagline').textContent = 'Discover your neighborhood'; });
  } catch(e) { document.getElementById('tagline').textContent = 'Discover your neighborhood'; }
}

function getApiKey() {
  // Extract key from the loaded Maps script tag
  const scripts = document.querySelectorAll('script[src*="maps.googleapis.com"]');
  for (const s of scripts) {
    const match = s.src.match(/key=([^&]+)/);
    if (match) return match[1];
  }
  return '';
}

// ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePref(el) {
  const p = el.dataset.pref;
  if (selectedPrefs.has(p)) { selectedPrefs.delete(p); el.classList.remove('active'); }
  else { selectedPrefs.add(p); el.classList.add('active'); }
}

// ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const slider  = document.getElementById('dist-slider');
const display = document.getElementById('dist-display');
slider.addEventListener('input', () => {
  display.innerHTML = `${slider.value} <span>miles</span>`;
  slider.style.setProperty('--pct', ((slider.value-slider.min)/(slider.max-slider.min))*100+'%');
});
slider.style.setProperty('--pct', '22.2%');

// ‚îÄ‚îÄ MAP STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAP_STYLES = [
  {featureType:'all',      elementType:'geometry', stylers:[{color:'#f5efe6'}]},
  {featureType:'road',     elementType:'geometry', stylers:[{color:'#ede0cc'}]},
  {featureType:'road.arterial', elementType:'geometry', stylers:[{color:'#d4c5a9'}]},
  {featureType:'water',    elementType:'geometry', stylers:[{color:'#a8cfe0'}]},
  {featureType:'poi.park', elementType:'geometry', stylers:[{color:'#c8dfc4'}]},
  {featureType:'poi',      elementType:'labels',   stylers:[{visibility:'off'}]},
  {featureType:'transit',  stylers:[{visibility:'off'}]},
];

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  // Map div is always visible with real dimensions - this is the key fix
  map = new google.maps.Map(document.getElementById('main-map'), {
    center: WEHOLOCENTER, zoom: 14,
    styles: MAP_STYLES,
    disableDefaultUI: true, zoomControl: true, gestureHandling: 'greedy',
  });

  directionsService  = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    polylineOptions: {strokeColor:'#3D2B1F', strokeWeight:4, strokeOpacity:0.85},
    suppressMarkers: false,
  });
  directionsRenderer.setMap(map);
  placesService = new google.maps.places.PlacesService(map);

  updateStreakUI();
  showStats('month', document.querySelector('.stats-tab.active'));

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userCenter = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        map.setCenter(userCenter);
        new google.maps.Marker({
          position: userCenter, map,
          icon: {path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#7BADC4', fillOpacity:1, strokeColor:'white', strokeWeight:2},
        });
        detectCity(userCenter.lat, userCenter.lng);
        fetchWeather(userCenter.lat, userCenter.lng);
      },
      () => {
        document.getElementById('tagline').textContent = 'West Hollywood ¬∑ Discover your neighborhood';
        fetchWeather(WEHOLOCENTER.lat, WEHOLOCENTER.lng);
      }
    );
  } else {
    document.getElementById('tagline').textContent = 'West Hollywood ¬∑ Discover your neighborhood';
    fetchWeather(WEHOLOCENTER.lat, WEHOLOCENTER.lng);
  }
}

// ‚îÄ‚îÄ HAVERSINE + BEARING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1, lng1, lat2, lng2) {
  const R=3958.8, dL=(lat2-lat1)*Math.PI/180, dl=(lng2-lng1)*Math.PI/180;
  const a = Math.sin(dL/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function getBearing(lat1, lng1, lat2, lng2) {
  const dLng = (lng2-lng1)*Math.PI/180;
  const y = Math.sin(dLng)*Math.cos(lat2*Math.PI/180);
  const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) - Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function turnArrow(txt) {
  const t = (txt||'').toLowerCase();
  if (t.includes('left'))  return '‚Ü∞';
  if (t.includes('right')) return '‚Ü±';
  if (t.includes('u-turn'))return '‚Ü©';
  if (t.includes('arrive')||t.includes('destination')) return 'üèÅ';
  return '‚Üë';
}

// ‚îÄ‚îÄ SHOW / HIDE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function show(id, flex) { document.getElementById(id).style.display = flex ? 'flex' : 'block'; }
function hide(id)       { document.getElementById(id).style.display = 'none'; }

// ‚îÄ‚îÄ GENERATE ROUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateRoute() {
  requestedMiles = parseFloat(slider.value);
  const center = userCenter || WEHOLOCENTER;

  // UI state: hide planner, show loading
  hide('planner-card');
  show('loading-box');
  hide('route-info-wrap');
  hide('ready-card');
  hide('turn-banner');
  hide('nav-stats-wrap');
  hide('streak-banner');
  document.querySelectorAll('.new-route-btn').forEach(b => b.remove());

  // Zoom out to show full route area
  map.setZoom(14);
  map.setCenter(center);

  const waypoints = [], foundSpots = [];
  const types = [...selectedPrefs].map(p => prefToType[p]).filter(Boolean);
  const uniqueTypes = [...new Set(types)];
  const angles = [0, 90, 180, 270, 45, 135, 225, 315];
  let ai = 0;
  const mpm = 1609.34;
  const radius = (requestedMiles / 4) * mpm;

  if (uniqueTypes.length > 0) {
    await Promise.all(uniqueTypes.slice(0,3).map(type => new Promise(resolve => {
      const angle = (angles[ai++ % angles.length] * Math.PI) / 180;
      const oLat = center.lat + (radius/111320)*Math.sin(angle);
      const oLng = center.lng + (radius/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle);
      placesService.nearbySearch({location:{lat:oLat, lng:oLng}, radius, type}, (results, status) => {
        if (status === 'OK' && results.length > 0) {
          const pick = results[Math.floor(Math.random()*Math.min(5, results.length))];
          waypoints.push({location:{lat:pick.geometry.location.lat(), lng:pick.geometry.location.lng()}, stopover:false});
          foundSpots.push({name:pick.name, type:[...selectedPrefs].find(p => prefToType[p]===type)});
        }
        resolve();
      });
    })));
  }

  // Always ensure at least one waypoint for a loop
  if (waypoints.length === 0) {
    const angle = Math.random() * 2 * Math.PI;
    const d = (requestedMiles / 3.5) * mpm;
    waypoints.push({
      location: {
        lat: center.lat + (d/111320)*Math.sin(angle),
        lng: center.lng + (d/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle)
      },
      stopover: false
    });
  }

  tryRoute(center, waypoints, foundSpots, requestedMiles, 0);
}

function tryRoute(center, waypoints, foundSpots, targetMiles, attempt) {
  // Keep loading visible during retry
  show('loading-box');

  directionsService.route({
    origin: center, destination: center, waypoints,
    travelMode: 'WALKING', optimizeWaypoints: true,
    avoidHighways: true, avoidTolls: true,
  }, (result, status) => {
    if (status === 'OK') {
      const leg = result.routes[0].legs;
      let totalDist = 0, totalTime = 0;
      leg.forEach(l => { totalDist += l.distance.value; totalTime += l.duration.value; });
      const distMiles = totalDist / 1609.34;
      const ratio = distMiles / targetMiles;

      // Retry with scaled waypoints if way off and haven't retried too many times
      if ((ratio > 1.25 || ratio < 0.75) && attempt < 2) {
        const scale = targetMiles / distMiles;
        const adjusted = waypoints.map(wp => ({
          location: {
            lat: center.lat + (wp.location.lat - center.lat) * scale,
            lng: center.lng + (wp.location.lng - center.lng) * scale,
          },
          stopover: false,
        }));
        tryRoute(center, adjusted, foundSpots, targetMiles, attempt + 1);
        return;
      }

      // Success - hide loading and show results
      hide('loading-box');

      lastDirectionsResult = result;
      actualRouteMiles = distMiles;
      allSteps = [];
      leg.forEach(l => l.steps.forEach(s => allSteps.push({
        instruction: s.instructions.replace(/<[^>]*>/g, ''),
        distance: s.distance.text,
        lat: s.start_location.lat(),
        lng: s.start_location.lng(),
      })));

      directionsRenderer.setDirections(result);

      // Show route pills
      document.getElementById('route-pills').innerHTML = `
        <div class="info-pill"><div class="val">${distMiles.toFixed(1)}</div><div class="lbl">Miles</div></div>
        <div class="info-pill"><div class="val">${Math.round(totalTime/60)}</div><div class="lbl">Est. Min</div></div>
        <div class="info-pill"><div class="val">${Math.round(distMiles*2000)}</div><div class="lbl">Est. Steps</div></div>`;

      // Show spots
      const sl = document.getElementById('spots-list');
      if (foundSpots.length > 0) {
        sl.innerHTML = `<div class="spots-title">Along your route</div>${foundSpots.map(s => `
          <div class="spot-item">
            <div class="spot-icon">${prefEmoji[s.type]||'üìç'}</div>
            <div><div class="spot-name">${s.name}</div><div class="spot-type">${s.type ? s.type.charAt(0).toUpperCase()+s.type.slice(1) : 'Point of interest'}</div></div>
          </div>`).join('')}`;
        sl.style.display = 'block';
      } else { sl.style.display = 'none'; }

      show('route-info-wrap');
      show('ready-card');
      document.getElementById('ready-sub').textContent = `${distMiles.toFixed(1)} mile loop ready. Let's go!`;

    } else {
      // Failed completely
      hide('loading-box');
      document.getElementById('route-pills').innerHTML = `<div class="info-pill" style="flex:1"><div class="val">üó∫Ô∏è</div><div class="lbl">Route unavailable ‚Äî try different prefs or longer distance</div></div>`;
      document.getElementById('spots-list').style.display = 'none';
      show('route-info-wrap');
      // Show new route button so user isn't stuck
      const btn = document.createElement('button');
      btn.className = 'new-route-btn'; btn.textContent = '‚Ü© Try again';
      btn.onclick = resetPlanner;
      document.getElementById('route-info-wrap').after(btn);
    }
  });
}

// ‚îÄ‚îÄ START WALKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startWalking() {
  hide('ready-card');
  hide('route-info-wrap');
  isWalking = true;

  // Switch to nav mode - zoom in, rotate enabled
  const center = userCenter || WEHOLOCENTER;
  map.setZoom(17);
  map.setCenter(center);
  map.setHeading(0);

  // User dot
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: center, map,
    icon: {path: google.maps.SymbolPath.CIRCLE, scale:10, fillColor:'#4285F4', fillOpacity:1, strokeColor:'white', strokeWeight:2.5},
    zIndex: 999,
  });

  // Blue walked trail
  if (walkedPath) walkedPath.setMap(null);
  walkedPath = new google.maps.Polyline({path:[], map, strokeColor:'#4285F4', strokeWeight:5, strokeOpacity:0.8});

  // Show nav UI
  show('turn-banner', true);
  show('nav-stats-wrap');
  updateTurnBanner();

  // Reset walk state
  walkDistanceMiles = 0; walkStartTime = Date.now();
  isPaused = false; walkUnlocked = false; currentStepIndex = 0; lastGeoPos = null;

  const cb = document.getElementById('complete-btn');
  cb.classList.remove('unlocked'); cb.disabled = true;
  document.getElementById('complete-hint').textContent = 'Walk 65% of your route to unlock';
  document.getElementById('pause-btn').textContent = '‚è∏ Pause';
  document.getElementById('nav-progress').style.width = '0%';

  // Timer
  walkTimerInterval = setInterval(() => {
    if (isPaused) return;
    const e = Math.floor((Date.now() - walkStartTime)/1000);
    const m = Math.floor(e/60), s = e%60;
    const t = `${m}:${s.toString().padStart(2,'0')}`;
    document.getElementById('nav-timer').textContent = t;
    document.getElementById('n-time').textContent = t;
  }, 1000);

  // GPS
  if (navigator.geolocation) {
    geoWatchId = navigator.geolocation.watchPosition(pos => {
      if (isPaused) return;
      const curr = {lat: pos.coords.latitude, lng: pos.coords.longitude};
      userMarker.setPosition(curr);
      map.panTo(curr);
      if (lastGeoPos) {
        const d = haversine(lastGeoPos.lat, lastGeoPos.lng, curr.lat, curr.lng);
        if (d > 0.003 && d < 0.3) {
          walkDistanceMiles += d;
          const hdg = getBearing(lastGeoPos.lat, lastGeoPos.lng, curr.lat, curr.lng);
          map.setHeading(hdg);
          walkedPath.getPath().push(new google.maps.LatLng(curr.lat, curr.lng));
        }
      } else {
        walkedPath.getPath().push(new google.maps.LatLng(curr.lat, curr.lng));
      }
      lastGeoPos = curr;
      updateNavUI(curr);
    }, {enableHighAccuracy:true, maximumAge:2000, timeout:15000});
  }
}

function updateTurnBanner() {
  if (!allSteps.length) return;
  const s = allSteps[Math.min(currentStepIndex, allSteps.length-1)];
  document.getElementById('turn-arrow').textContent = turnArrow(s.instruction);
  document.getElementById('turn-instruction').textContent = s.instruction;
  document.getElementById('turn-dist').textContent = s.distance || '';
}

function updateNavUI(curr) {
  const pct = Math.min(walkDistanceMiles / actualRouteMiles, 1);
  document.getElementById('n-dist').textContent = walkDistanceMiles.toFixed(2);
  document.getElementById('n-steps').textContent = Math.round(walkDistanceMiles*2000).toLocaleString();
  document.getElementById('n-pct').textContent = Math.round(pct*100)+'%';
  document.getElementById('nav-progress').style.width = Math.round(pct*100)+'%';

  // Advance turn steps by proximity
  if (currentStepIndex < allSteps.length - 1) {
    const next = allSteps[currentStepIndex + 1];
    if (haversine(curr.lat, curr.lng, next.lat, next.lng) < 0.04) {
      currentStepIndex++;
      updateTurnBanner();
      try {
        const u = new SpeechSynthesisUtterance(allSteps[currentStepIndex].instruction);
        u.rate = 0.95; window.speechSynthesis.speak(u);
      } catch(e) {}
    }
  }

  if (pct >= 0.65 && !walkUnlocked) {
    walkUnlocked = true;
    const btn = document.getElementById('complete-btn');
    btn.classList.add('unlocked'); btn.disabled = false;
    document.getElementById('complete-hint').textContent = "You've earned it ‚Äî tap to complete! üéâ";
  }
}

// ‚îÄ‚îÄ PAUSE / CANCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePause() {
  isPaused = !isPaused;
  document.getElementById('pause-btn').textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
}

function cancelWalk() {
  stopTracking();
  isWalking = false;
  hide('turn-banner');
  hide('nav-stats-wrap');
  map.setZoom(14);
  map.setHeading(0);
  if (lastDirectionsResult) directionsRenderer.setDirections(lastDirectionsResult);
  show('route-info-wrap');
  show('ready-card');
  document.getElementById('ready-sub').textContent = 'Walk cancelled. Want to try again?';
}

function stopTracking() {
  if (geoWatchId !== null) { navigator.geolocation.clearWatch(geoWatchId); geoWatchId = null; }
  clearInterval(walkTimerInterval);
  try { window.speechSynthesis.cancel(); } catch(e) {}
}

// ‚îÄ‚îÄ COMPLETE WALK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function completeWalk() {
  stopTracking();
  isWalking = false;
  hide('turn-banner');
  hide('nav-stats-wrap');
  map.setZoom(14);
  map.setHeading(0);

  const finalMiles = Math.max(walkDistanceMiles, actualRouteMiles * 0.65);
  logWalkStats(finalMiles.toFixed(2));
  showStats('month', document.querySelector('.stats-tab.active'));

  const newStreak = recordWalk();
  updateStreakUI();

  const banner = document.getElementById('streak-banner');
  document.getElementById('streak-banner-num').textContent = `üî• ${newStreak} Day Streak!`;
  const msgs = {1:"You started your streak ‚Äî come back tomorrow!", 7:"üèÜ 7 days! You absolutely crushed it!"};
  document.getElementById('streak-banner-msg').textContent = msgs[newStreak] || (newStreak%7===0 ? `${newStreak} days strong. Incredible!` : `Keep it up ‚Äî ${7-(newStreak%7)} days to your next milestone!`);
  show('streak-banner');

  const btn = document.createElement('button');
  btn.className = 'new-route-btn'; btn.textContent = '‚Ü© Plan a new walk';
  btn.onclick = resetPlanner;
  banner.insertAdjacentElement('afterend', btn);
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetPlanner() {
  stopTracking();
  isWalking = false;
  hide('route-info-wrap');
  hide('ready-card');
  hide('turn-banner');
  hide('nav-stats-wrap');
  hide('streak-banner');
  document.querySelectorAll('.new-route-btn').forEach(b => b.remove());
  show('planner-card');
  // Clear route from map
  directionsRenderer.setDirections({routes:[]});
  if (userMarker) { userMarker.setMap(null); userMarker = null; }
  if (walkedPath)  { walkedPath.setMap(null); walkedPath = null; }
  // Re-center on user
  const center = userCenter || WEHOLOCENTER;
  map.setCenter(center); map.setZoom(14); map.setHeading(0);
  // Add back the user dot
  new google.maps.Marker({
    position: center, map,
    icon: {path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#7BADC4', fillOpacity:1, strokeColor:'white', strokeWeight:2},
  });
  isPaused = false; walkUnlocked = false;
}
</script>

<!-- Replace AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc with your actual Google Maps API key -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc&libraries=places&callback=initMap"></script>

</body>
</html>
