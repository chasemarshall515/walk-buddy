<!DOCTYPE html>
<html lang="en" style="color-scheme:light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="description" content="Walk Buddy ‚Äî discover your neighborhood one walk at a time.">
<meta name="theme-color" content="#8FAF8C">
<meta name="color-scheme" content="light">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Walk Buddy</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<!-- ‚ïê‚ïê‚ïê SERVICE INTEGRATIONS ‚ïê‚ïê‚ïê -->
<!-- Supabase ‚Äî backend & persistent data (replace localStorage) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" async></script>
<!-- Sentry ‚Äî error tracking & performance monitoring -->
<script src="https://browser.sentry-cdn.com/8.40.0/bundle.tracing.min.js" crossorigin="anonymous" async></script>
<!-- PostHog ‚Äî product analytics -->
<script>
  !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
</script>
<style>
/* ‚îÄ‚îÄ ALWAYS LIGHT ‚Äî dark mode intentionally disabled ‚îÄ‚îÄ */
:root {
  --primary:#8FAF8C; --bg:#F7F3EC; --dark:#3D2B1F; --mid:#D4C5A9;
  --accent:#7BADC4; --warm:#E8D5B7; --card:#ffffff;
  --text-sub:#7a6355; --text-muted:#6b5d52; --danger:#c85050;
  --card-border:transparent;
}
[data-theme="ocean"] { --primary:#5B9EC9; --bg:#EEF5FA; --dark:#1A3A4A; --mid:#B8D4E8; --accent:#F4A261; --warm:#D6EAF5; --card:#ffffff; --text-sub:#3a6070; --text-muted:#4a7080; --card-border:transparent; }
[data-theme="city"]  { --primary:#A0A0A0; --bg:#1A1A1A; --dark:#F0F0F0; --mid:#333333; --accent:#E8C547; --warm:#2A2A2A; --card:#242424; --text-sub:#A0A0A0; --text-muted:#909090; --card-border:rgba(255,255,255,0.07); }
[data-theme="bloom"] { --primary:#C77DBA; --bg:#FDF0F8; --dark:#3D1A35; --mid:#E8C5DF; --accent:#F4A261; --warm:#F5E0F0; --card:#ffffff; --text-sub:#7a3a6a; --text-muted:#6a4a62; --card-border:transparent; }

* { box-sizing:border-box; margin:0; padding:0; }
html { background:#F7F3EC; }
body {
  font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--dark);
  min-height:100svh; overflow-x:hidden; transition:background 0.4s,color 0.4s;
  padding-bottom:env(safe-area-inset-bottom);
}
header { padding:calc(1.25rem + env(safe-area-inset-top)) 1rem 0.25rem; text-align:center; position:relative; z-index:1; }
body.walking { overscroll-behavior-y:none; }
body::before { content:''; position:fixed; top:-120px; right:-120px; width:400px; height:400px; border-radius:50%; background:radial-gradient(circle,var(--primary) 0%,transparent 70%); opacity:0.2; pointer-events:none; z-index:0; }
body::after  { content:''; position:fixed; bottom:-80px; left:-80px; width:300px; height:300px; border-radius:50%; background:radial-gradient(circle,var(--accent) 0%,transparent 70%); opacity:0.15; pointer-events:none; z-index:0; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.logo { font-family:'DM Serif Display',serif; font-size:2.4rem; color:var(--dark); letter-spacing:-0.5px; }
.logo span { color:var(--primary); font-style:italic; }
.tagline { font-size:0.78rem; font-weight:300; color:var(--text-sub); margin-top:0.2rem; letter-spacing:0.08em; text-transform:uppercase; min-height:1.2em; }

/* ‚îÄ‚îÄ CUSTOM THEME PICKER ‚îÄ‚îÄ */
.theme-picker-wrap { position:absolute; top:calc(0.85rem + env(safe-area-inset-top)); right:0.75rem; z-index:100; }
.theme-picker { display:flex; gap:0.25rem; background:var(--card); border:1.5px solid var(--mid); border-radius:100px; padding:0.18rem 0.3rem; box-shadow:0 2px 8px rgba(0,0,0,0.07); }
.theme-btn { background:none; border:none; border-radius:100px; padding:0.2rem 0.3rem; font-size:0.85rem; cursor:pointer; opacity:0.45; transition:opacity 0.15s, background 0.15s; line-height:1; }
.theme-btn.active { opacity:1; background:var(--mid); }
.theme-btn:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.top-bar { display:flex; justify-content:center; gap:0.5rem; padding:0.4rem 1rem 0.5rem; max-width:480px; margin:0 auto; flex-wrap:wrap; position:relative; z-index:1; }
.top-pill { display:flex; align-items:center; gap:0.35rem; background:var(--card); border:1px solid var(--card-border); border-radius:100px; padding:0.35rem 0.75rem; font-size:0.78rem; font-weight:500; color:var(--dark); box-shadow:0 2px 10px rgba(0,0,0,0.07); transition:background 0.4s,color 0.4s; }
.top-pill .pill-sub { font-size:0.64rem; color:var(--text-muted); font-weight:400; }
.streak-pill.has-streak { background:var(--dark); color:var(--bg); }
.streak-pill.has-streak .pill-sub { color:var(--mid); }

/* ‚îÄ‚îÄ WEATHER SHIMMER ‚îÄ‚îÄ */
.weather-shimmer { display:inline-block; width:42px; height:0.9em; border-radius:4px; background:linear-gradient(90deg,var(--mid) 25%,var(--warm) 50%,var(--mid) 75%); background-size:200% 100%; animation:shimmer 1.4s ease-in-out infinite; vertical-align:middle; }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* ‚îÄ‚îÄ GPS STATUS ‚îÄ‚îÄ */
.gps-status { display:flex; align-items:center; justify-content:center; gap:0.5rem; font-size:0.75rem; color:var(--text-sub); padding:0.5rem; }
.gps-pulse { width:8px; height:8px; border-radius:50%; background:var(--accent); animation:gpspulse 1.2s ease-in-out infinite; flex-shrink:0; }
@keyframes gpspulse { 0%,100%{opacity:0.3;transform:scale(0.8)} 50%{opacity:1;transform:scale(1.2)} }
.gps-status.acquired .gps-pulse { background:var(--primary); animation:none; opacity:1; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background:var(--card); border:1px solid var(--card-border); border-radius:20px; padding:1.5rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 24px rgba(0,0,0,0.06); transition:background 0.4s; position:relative; z-index:1; }
.section-label { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.12em; color:var(--primary); margin-bottom:0.65rem; }

/* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
.label-row { display:flex; align-items:center; gap:0.4rem; margin-bottom:0.65rem; }
.label-row .section-label { margin-bottom:0; }
.info-btn { background:none; border:1.5px solid var(--mid); border-radius:50%; width:20px; height:20px; font-size:0.62rem; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; padding:0; line-height:1; min-width:20px; }
.info-btn:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.tooltip-wrap { position:relative; display:inline-flex; }
.tooltip-box { position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%); background:var(--dark); color:var(--bg); font-size:0.72rem; padding:0.6rem 0.8rem; border-radius:10px; width:220px; line-height:1.5; pointer-events:none; opacity:0; transition:opacity 0.15s; z-index:200; text-align:left; font-weight:400; text-transform:none; letter-spacing:0; }
.tooltip-box::after { content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:5px solid transparent; border-top-color:var(--dark); }
.tooltip-visible { opacity:1 !important; }

/* ‚îÄ‚îÄ DISTANCE DISPLAY ‚îÄ‚îÄ */
.distance-display { font-family:'DM Serif Display',serif; font-size:3rem; color:var(--dark); line-height:1; margin-bottom:0.1rem; }
.distance-display span { font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:300; color:var(--text-sub); }
.walk-time-est { font-size:0.78rem; color:var(--text-muted); margin-bottom:0.15rem; }
input[type=range] { -webkit-appearance:none; width:100%; height:6px; border-radius:3px; background:linear-gradient(to right,var(--primary) 0%,var(--primary) var(--pct,30%),var(--mid) var(--pct,30%),var(--mid) 100%); margin:0.7rem 0 0.35rem; outline:none; cursor:pointer; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:var(--dark); border:3px solid var(--card); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
input[type=range]:focus { outline:2px solid var(--primary); outline-offset:4px; border-radius:3px; }
.range-labels { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-muted); }

/* ‚îÄ‚îÄ UNIT & TEMP TOGGLES ‚îÄ‚îÄ */
.toggles-row { display:flex; gap:1rem; margin-top:0.5rem; flex-wrap:wrap; }
.toggle-group { display:flex; align-items:center; gap:0.4rem; font-size:0.75rem; color:var(--text-muted); }
.toggle-group button { padding:0.2rem 0.6rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; font-size:0.72rem; font-family:'DM Sans',sans-serif; color:var(--dark); cursor:pointer; min-height:28px; }
.toggle-group button.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }

/* ‚îÄ‚îÄ DISTANCE PRESETS ‚îÄ‚îÄ */
.dist-presets { display:flex; gap:0.4rem; margin-top:0.35rem; }
.dist-preset { flex:1; padding:0.3rem 0; border-radius:8px; border:1.5px solid var(--mid); background:transparent; font-size:0.72rem; font-family:'DM Sans',sans-serif; color:var(--dark); cursor:pointer; text-align:center; min-height:32px; transition:all 0.15s; -webkit-tap-highlight-color:transparent; }
.dist-preset:hover { border-color:var(--primary); color:var(--primary); }
.dist-preset.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }

/* ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ */
.prefs-grid { display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem; }
.pref-chip { display:flex; align-items:center; gap:0.35rem; padding:0.45rem 0.85rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; cursor:pointer; font-size:0.8rem; font-family:'DM Sans',sans-serif; color:var(--dark); transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1); -webkit-tap-highlight-color:transparent; min-height:36px; }
.pref-chip:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.pref-chip:active { transform:scale(0.93); }
.pref-chip.active { background:var(--dark); border-color:var(--dark); color:var(--bg); transform:scale(1.03); }
.pref-chip.active::after { content:'‚úì'; font-size:0.7rem; margin-left:0.1rem; opacity:0.7; }
.pref-chip.maxed:not(.active) { opacity:0.4; cursor:default; }
.pref-chip .icon { font-size:0.9rem; }
.pref-counter { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
.pref-counter span { color:var(--primary); font-weight:500; }

/* ‚îÄ‚îÄ CRAZY MODE ‚îÄ‚îÄ */
.crazy-toggle-wrap { margin-top:0.85rem; padding-top:0.75rem; border-top:1px solid var(--warm); }
.crazy-toggle { display:flex; align-items:center; gap:0.65rem; cursor:pointer; -webkit-tap-highlight-color:transparent; padding:0.35rem 0; }
.crazy-toggle input { display:none; }
.crazy-track { width:42px; height:24px; border-radius:100px; background:var(--mid); position:relative; transition:background 0.25s; flex-shrink:0; }
.crazy-thumb { position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%; background:var(--card); box-shadow:0 1px 4px rgba(0,0,0,0.2); transition:transform 0.25s cubic-bezier(0.34,1.56,0.64,1); }
.crazy-toggle input:checked ~ .crazy-track { background:var(--accent); }
.crazy-toggle input:checked ~ .crazy-track .crazy-thumb { transform:translateX(18px); }
.crazy-label { display:flex; flex-direction:column; gap:0.1rem; }
.crazy-label-main { font-size:0.82rem; font-weight:500; color:var(--dark); display:flex; align-items:center; gap:0.35rem; }
.crazy-label-sub { font-size:0.68rem; color:var(--text-muted); line-height:1.4; }
.crazy-toggle input:checked ~ .crazy-label .crazy-label-main { color:var(--accent); }
/* Wiggle animation on the emoji when active */
@keyframes crazyWiggle { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-12deg)} 75%{transform:rotate(12deg)} }
.crazy-toggle input:checked ~ .crazy-label .crazy-emoji { animation:crazyWiggle 0.5s ease-in-out 1; display:inline-block; }
/* Pulsing border accent when crazy mode is on */
.card.crazy-active { border:1.5px solid var(--accent); box-shadow:0 4px 24px rgba(0,0,0,0.06), 0 0 0 1px rgba(123,173,196,0.15); }

/* ‚îÄ‚îÄ GENERATE BTN ‚îÄ‚îÄ */
.generate-btn { width:100%; padding:1rem; border-radius:14px; border:none; background:var(--primary); color:var(--dark); font-family:'DM Serif Display',serif; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-top:1.1rem; -webkit-tap-highlight-color:transparent; transition:box-shadow 0.2s, transform 0.12s, filter 0.15s; box-shadow:0 6px 20px rgba(143,175,140,0.5); font-weight:400; letter-spacing:0.01em; }
.generate-btn:not(:disabled):hover { filter:brightness(1.06); box-shadow:0 8px 28px rgba(143,175,140,0.6); }
.generate-btn:not(:disabled):active { transform:scale(0.972); box-shadow:0 2px 10px rgba(143,175,140,0.3); filter:brightness(0.96); }
.generate-btn:disabled { opacity:0.38; cursor:not-allowed; box-shadow:none; filter:none; animation:none !important; }
.generate-btn:focus-visible { outline:2px solid var(--dark); outline-offset:3px; }
@keyframes genPulse { 0%,100%{box-shadow:0 6px 20px rgba(143,175,140,0.45)} 50%{box-shadow:0 6px 32px rgba(143,175,140,0.75)} }
.generate-btn:not(:disabled) { animation:genPulse 2.8s ease-in-out infinite; }
.generate-waiting { font-size:0.72rem; color:var(--text-muted); text-align:center; margin-top:0.4rem; }

/* ‚îÄ‚îÄ DIST MISMATCH ‚îÄ‚îÄ */
.dist-mismatch { font-size:0.72rem; color:var(--text-muted); background:var(--warm); border-radius:8px; padding:0.5rem 1rem; margin:0 auto 0.5rem; max-width:480px; display:none; line-height:1.45; }

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
.map-wrap { max-width:480px; margin:0.5rem auto; padding:0 0.5rem; position:relative; z-index:1; }
#main-map { width:100%; height:min(360px,45svh); border-radius:18px; overflow:hidden; box-shadow:0 4px 24px rgba(0,0,0,0.1); background:var(--warm); display:flex; align-items:center; justify-content:center; }
#main-map .map-placeholder { text-align:center; color:var(--text-muted); font-size:0.85rem; padding:2rem; }
#main-map .map-placeholder .map-ph-icon { font-size:2.5rem; margin-bottom:0.5rem; display:block; }

/* GPS badge */
.gps-badge { position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.65); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border-radius:100px; padding:0.35rem 0.7rem; display:flex; align-items:center; gap:0.4rem; z-index:8; transition:opacity 0.4s; }
.gps-badge.hidden { opacity:0; pointer-events:none; }
.gps-badge-dot { width:7px; height:7px; border-radius:50%; background:#4ade80; flex-shrink:0; }
.gps-badge-dot.locating { animation:gpspulse 1.1s ease-in-out infinite; background:#facc15; }
.gps-badge-dot.denied   { background:#f87171; animation:none; }
.gps-badge-text { font-size:0.68rem; color:rgba(255,255,255,0.9); white-space:nowrap; font-family:'DM Sans',sans-serif; }

/* Permission prompt */
.location-prompt { background:var(--dark); color:var(--bg); border-radius:16px; padding:1rem 1.1rem; margin:0 auto 0.5rem; max-width:480px; display:none; position:relative; z-index:1; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
.lp-row { display:flex; align-items:center; gap:0.75rem; }
.lp-emoji { font-size:1.8rem; flex-shrink:0; }
.lp-content { flex:1; }
.lp-headline { font-family:'DM Serif Display',serif; font-size:1rem; margin-bottom:0.2rem; }
.lp-desc { font-size:0.75rem; opacity:0.7; line-height:1.45; }
.lp-allow-btn { background:var(--primary); color:var(--dark); border:none; border-radius:10px; padding:0.6rem 1.1rem; font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:500; cursor:pointer; min-height:44px; white-space:nowrap; -webkit-tap-highlight-color:transparent; flex-shrink:0; transition:filter 0.15s; }
.lp-allow-btn:active { filter:brightness(0.9); }

/* Denied overlay */
.map-denied-overlay { position:absolute; inset:0; margin:0 0.5rem; border-radius:18px; background:rgba(0,0,0,0.72); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.65rem; z-index:5; padding:1.5rem; text-align:center; pointer-events:none; opacity:0; transition:opacity 0.3s; }
.map-denied-overlay.visible { opacity:1; pointer-events:all; }
.map-denied-icon  { font-size:2.5rem; }
.map-denied-title { font-family:'DM Serif Display',serif; font-size:1.1rem; color:#fff; }
.map-denied-sub   { font-size:0.75rem; color:rgba(255,255,255,0.75); line-height:1.5; max-width:260px; }
.map-denied-btn   { background:#fff; color:#3D2B1F; border:none; border-radius:100px; padding:0.6rem 1.2rem; font-size:0.85rem; font-weight:500; cursor:pointer; min-height:44px; margin-top:0.25rem; -webkit-tap-highlight-color:transparent; }

/* Loading overlay */
.loading-box { display:none; position:absolute; inset:0; margin:0 0.5rem; border-radius:18px; background:rgba(61,43,31,0.82); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; z-index:6; text-align:center; padding:1.5rem; }
.walk-anim { font-size:2.4rem; animation:walkBounce 0.5s ease-in-out infinite alternate; display:inline-block; }
@keyframes walkBounce { 0%{transform:translateY(0) translateX(-4px) rotate(-3deg)} 100%{transform:translateY(-7px) translateX(4px) rotate(3deg)} }
.loading-text { font-family:'DM Serif Display',serif; font-size:1.1rem; color:#fff; margin-top:0.4rem; }
.loading-sub  { font-size:0.76rem; color:rgba(255,255,255,0.72); min-height:1.1em; transition:opacity 0.25s; }
.loading-progress { width:55%; height:3px; background:rgba(255,255,255,0.2); border-radius:3px; margin-top:1rem; overflow:hidden; }
.loading-progress-bar { height:100%; background:var(--primary); border-radius:3px; animation:loadpulse 1.6s ease-in-out infinite; }
@keyframes loadpulse { 0%{width:0%;margin-left:0} 50%{width:65%;margin-left:15%} 100%{width:0%;margin-left:100%} }

/* ‚îÄ‚îÄ MAP LOCK ‚îÄ‚îÄ */
.map-lock-btn { position:absolute; bottom:12px; right:12px; background:rgba(0,0,0,0.65); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border:none; border-radius:8px; padding:0.4rem 0.55rem; font-size:0.7rem; cursor:pointer; z-index:10; color:rgba(255,255,255,0.9); font-family:'DM Sans',sans-serif; display:none; -webkit-tap-highlight-color:transparent; min-height:36px; }
.map-lock-btn.locked { background:rgba(255,255,255,0.9); color:#3D2B1F; }

/* ‚îÄ‚îÄ RIPPLE EFFECT ‚îÄ‚îÄ */
.ripple-wrap { position:relative; overflow:hidden; }
@keyframes ripple { to { transform:scale(4); opacity:0; } }
.ripple-circle { position:absolute; border-radius:50%; width:60px; height:60px; margin-top:-30px; margin-left:-30px; background:rgba(255,255,255,0.3); transform:scale(0); animation:ripple 0.5s linear; pointer-events:none; z-index:9; }

/* ‚îÄ‚îÄ CARD ENTRY ANIMATION ‚îÄ‚îÄ */
@keyframes cardSlideIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ ERROR CARD ‚îÄ‚îÄ */
.error-card { display:none; background:var(--card); border:1.5px solid rgba(200,80,80,0.25); border-radius:16px; padding:1.1rem; margin:0 auto 0.5rem; max-width:480px; position:relative; z-index:1; text-align:center; }
.error-card-icon { font-size:1.8rem; margin-bottom:0.4rem; }
.error-card-title { font-family:'DM Serif Display',serif; font-size:1rem; color:var(--danger); margin-bottom:0.25rem; }
.error-card-msg   { font-size:0.8rem; color:var(--text-sub); line-height:1.5; margin-bottom:0.85rem; }
.error-card-retry { padding:0.65rem 1.4rem; border-radius:10px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; min-height:44px; }

/* ‚îÄ‚îÄ STATS EMPTY ‚îÄ‚îÄ */
.stats-empty-wrap { text-align:center; padding:1.5rem 0.5rem 0.5rem; }
.stats-empty-icon { font-size:2.5rem; margin-bottom:0.5rem; opacity:0.7; }
.stats-empty-title { font-family:'DM Serif Display',serif; font-size:1.05rem; color:var(--dark); margin-bottom:0.3rem; }
.stats-empty-body  { font-size:0.78rem; color:var(--text-muted); line-height:1.6; margin-bottom:0.8rem; }
.stats-start-cta { display:inline-block; padding:0.55rem 1.1rem; border-radius:10px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.82rem; cursor:pointer; min-height:40px; -webkit-tap-highlight-color:transparent; }

/* ‚îÄ‚îÄ BUTTON ACTIVE MICRO-ANIMATION ‚îÄ‚îÄ */
button:not(:disabled):active { transition:transform 0.08s !important; }
.ready-yes:active   { transform:scale(0.97); }
.recap-new:active   { transform:scale(0.97); }
.lp-allow-btn:active { transform:scale(0.97); }
.onboard-next:active { transform:scale(0.97); }

/* ‚îÄ‚îÄ LOCATION ERROR ‚îÄ‚îÄ */
.location-error { background:var(--card); border:1px solid var(--card-border); border-radius:16px; padding:1.25rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 20px rgba(0,0,0,0.06); display:none; text-align:center; position:relative; z-index:1; }
.location-error p { font-size:0.85rem; color:var(--text-sub); margin-bottom:0.85rem; line-height:1.55; }
.btn-retry { padding:0.6rem 1.2rem; border-radius:10px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; min-height:44px; }

/* ‚îÄ‚îÄ ROUTE INFO ‚îÄ‚îÄ */
.route-info { display:none; flex-direction:column; gap:0.5rem; max-width:480px; margin:0 auto 0.5rem; padding:0 0.5rem; position:relative; z-index:1; }
.route-pills { display:flex; gap:0.5rem; }
.info-pill { flex:1; background:var(--card); border:1px solid var(--card-border); border-radius:12px; padding:0.7rem 0.5rem; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); min-height:64px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.info-pill .val { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); line-height:1; }
.info-pill .lbl { font-size:0.64rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); margin-top:0.25rem; }
.spots-list { background:var(--card); border:1px solid var(--card-border); border-radius:14px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:none; }
.spots-title { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.1em; color:var(--primary); margin-bottom:0.65rem; }
.spot-item { display:flex; align-items:center; gap:0.65rem; padding:0.4rem 0; border-bottom:1px solid var(--warm); font-size:0.85rem; color:var(--dark); }
.spot-item:last-child { border-bottom:none; }
.spot-icon { width:28px; height:28px; border-radius:7px; background:var(--warm); display:flex; align-items:center; justify-content:center; font-size:0.9rem; flex-shrink:0; }
.spot-name { font-weight:500; }
.spot-type { font-size:0.72rem; color:var(--text-muted); }
.poi-feedback { font-size:0.72rem; color:var(--text-muted); margin-top:0.5rem; padding:0.5rem 0.75rem; background:var(--warm); border-radius:8px; line-height:1.5; }

/* ‚îÄ‚îÄ READY CARD ‚îÄ‚îÄ */
.ready-card { background:var(--card); border:1px solid var(--card-border); border-radius:20px; padding:1.4rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 20px rgba(0,0,0,0.06); text-align:center; display:none; position:relative; z-index:1; }
.ready-title { font-family:'DM Serif Display',serif; font-size:1.5rem; color:var(--dark); margin-bottom:0.35rem; }
.ready-sub { font-size:0.82rem; color:var(--text-muted); margin-bottom:1.1rem; }
.ready-btns { display:flex; gap:0.65rem; }
.ready-yes { flex:2; padding:0.8rem; border-radius:12px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.05rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:48px; }
.ready-yes:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.ready-no  { flex:1; padding:0.8rem; border-radius:12px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:48px; }
.ready-no:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.ready-cancel { display:block; width:100%; background:none; border:none; color:var(--text-muted); font-size:0.82rem; font-family:'DM Sans',sans-serif; padding:0.65rem 0 0.25rem; cursor:pointer; min-height:44px; }
.saved-route-bar { display:none; align-items:center; justify-content:space-between; background:var(--dark); color:var(--bg); border-radius:14px; padding:0.75rem 1rem; margin:0 auto 0.5rem; max-width:480px; position:relative; z-index:1; }
.saved-route-label { font-size:0.82rem; opacity:0.8; }
.saved-route-start { padding:0.45rem 1rem; border-radius:9px; border:1.5px solid rgba(255,255,255,0.3); background:transparent; color:var(--bg); font-family:'DM Serif Display',serif; font-size:0.9rem; cursor:pointer; min-height:36px; }

/* ‚îÄ‚îÄ TURN BANNER ‚îÄ‚îÄ */
.turn-banner { background:var(--dark); color:var(--bg); border-radius:14px; padding:0.75rem 1rem; margin:0 auto 0.5rem; display:none; align-items:center; gap:0.75rem; box-shadow:0 4px 16px rgba(0,0,0,0.2); max-width:480px; position:relative; z-index:1; }
.turn-arrow { font-size:1.5rem; flex-shrink:0; min-width:2rem; text-align:center; }
.turn-text { flex:1; }
.turn-instruction { font-size:0.9rem; font-weight:500; line-height:1.35; }
.turn-dist  { font-size:0.7rem; opacity:0.6; margin-top:0.1rem; }
.turn-timer { font-size:0.78rem; opacity:0.75; flex-shrink:0; font-variant-numeric:tabular-nums; }

/* ‚îÄ‚îÄ NAV STATS ‚îÄ‚îÄ */
.nav-stats-wrap { display:none; flex-direction:column; gap:0.5rem; max-width:480px; margin:0 auto; padding:0 0.5rem 0.5rem; position:relative; z-index:1; }
.nav-progress-wrap { background:var(--mid); border-radius:100px; height:6px; overflow:hidden; }
.nav-progress-bar { height:100%; border-radius:100px; background:var(--primary); transition:width 0.8s ease; width:0%; }
.complete-wrap { position:relative; }
.complete-btn { width:100%; padding:0.85rem; border-radius:12px; border:none; background:var(--primary); color:var(--dark); font-family:'DM Serif Display',serif; font-size:1.1rem; cursor:pointer; opacity:0.3; transition:opacity 0.3s; -webkit-tap-highlight-color:transparent; position:relative; overflow:hidden; }
.complete-btn.unlocked { opacity:1; }
.complete-btn:focus-visible { outline:2px solid var(--dark); outline-offset:2px; }
.complete-progress-fill { position:absolute; bottom:0; left:0; height:3px; background:rgba(61,43,31,0.35); transition:width 0.8s ease; pointer-events:none; border-radius:0 0 12px 12px; }
.complete-hint { font-size:0.7rem; color:var(--text-muted); text-align:center; }
.nav-stats { display:flex; gap:0.5rem; }
.ns { flex:1; background:var(--card); border:1px solid var(--card-border); border-radius:12px; padding:0.6rem 0.4rem; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
.ns .nv { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--dark); }
.ns .nl { font-size:0.6rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.1rem; }
.walk-actions { display:flex; gap:0.5rem; }
.pause-btn  { flex:1; padding:0.7rem; border-radius:11px; border:1.5px solid var(--mid); background:var(--card); color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:44px; }
.cancel-btn { flex:1; padding:0.7rem; border-radius:11px; border:1.5px solid rgba(200,80,80,0.3); background:var(--card); color:var(--danger); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:44px; }
.voice-btn  { padding:0.7rem 0.9rem; border-radius:11px; border:1.5px solid var(--mid); background:var(--card); font-size:1rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:44px; line-height:1; }
.pause-btn:focus-visible, .cancel-btn:focus-visible, .voice-btn:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.end-walk-btn { width:100%; padding:0.65rem; border-radius:11px; border:1.5px solid rgba(200,80,80,0.25); background:transparent; color:var(--danger); font-family:'DM Sans',sans-serif; font-size:0.82rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:44px; }

/* ‚îÄ‚îÄ SUSPENDED BANNER ‚îÄ‚îÄ */
.suspended-banner { background:#fff8e1; border:1.5px solid #f0c040; border-radius:12px; padding:0.75rem 1rem; margin:0 auto 0.5rem; max-width:480px; font-size:0.8rem; color:#7a5f00; display:none; text-align:center; position:relative; z-index:2; }

/* ‚îÄ‚îÄ WALK RECAP ‚îÄ‚îÄ */
.recap-card { background:var(--card); border:1px solid var(--card-border); border-radius:20px; padding:1.5rem 1.5rem 1.25rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 24px rgba(0,0,0,0.08); display:none; text-align:center; position:relative; z-index:1; overflow:hidden; }
.recap-confetti { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
.recap-confetti span { position:absolute; font-size:1.2rem; animation:confettiFall 1.8s ease-out forwards; }
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0deg);opacity:1} 100%{transform:translateY(120px) rotate(360deg);opacity:0} }
.recap-hero { margin-bottom:0.75rem; padding-bottom:0.75rem; border-bottom:1px solid var(--warm); }
.recap-hero-dist { font-family:'DM Serif Display',serif; font-size:4rem; color:var(--dark); line-height:1; }
.recap-hero-unit { font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:300; color:var(--text-sub); }
.recap-hero-streak { font-size:1.1rem; color:var(--primary); font-weight:500; margin-top:0.2rem; }
.recap-title { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); margin-bottom:0.15rem; }
.recap-subtitle { font-size:0.78rem; color:var(--text-muted); margin-bottom:0.85rem; }
.recap-stats { display:flex; gap:0.5rem; margin-bottom:1rem; }
.recap-stat { flex:1; background:var(--warm); border-radius:12px; padding:0.65rem 0.4rem; }
.recap-stat .rv { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); }
.recap-stat .rl { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.1rem; }
.recap-actions { display:flex; gap:0.5rem; }
.recap-new   { flex:1; padding:0.75rem; border-radius:11px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:0.95rem; cursor:pointer; min-height:44px; }
.recap-share { flex:1; padding:0.75rem; border-radius:11px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; min-height:44px; }

/* ‚îÄ‚îÄ STREAK BANNER ‚îÄ‚îÄ */
.streak-banner { background:var(--dark); color:var(--bg); border-radius:16px; padding:1rem 1.2rem; margin:0.5rem auto; max-width:480px; text-align:center; display:none; box-shadow:0 4px 16px rgba(0,0,0,0.12); position:relative; z-index:1; }
.streak-num { font-family:'DM Serif Display',serif; font-size:1.6rem; }
.streak-msg { font-size:0.78rem; color:var(--mid); margin-top:0.2rem; }

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-card { margin-bottom:2rem; }
.stats-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.9rem; flex-wrap:wrap; gap:0.5rem; }
.stats-tabs { display:flex; gap:0.35rem; }
.stats-tab { padding:0.28rem 0.7rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; font-size:0.72rem; font-family:'DM Sans',sans-serif; color:var(--dark); cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:32px; }
.stats-tab:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
.stats-tab.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }
.stats-big { display:flex; gap:0.5rem; margin-bottom:0.6rem; }
.sbb { flex:1; background:var(--warm); border-radius:14px; padding:0.9rem 0.7rem; text-align:center; }
.sbb .sv { font-family:'DM Serif Display',serif; font-size:1.8rem; color:var(--dark); line-height:1; }
.sbb .sl { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.25rem; }
.stats-small { display:flex; gap:0.5rem; }
.ssb { flex:1; background:var(--warm); border-radius:11px; padding:0.65rem 0.5rem; text-align:center; }
.ssb .sv { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--dark); }
.ssb .sl { font-size:0.6rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); margin-top:0.1rem; }
.month-history { margin-top:0.7rem; }
.month-row { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--warm); }
.month-row:last-child { border-bottom:none; }
.month-name { font-weight:500; font-size:0.85rem; }
.month-right { text-align:right; }
.month-miles { font-family:'DM Serif Display',serif; font-size:0.95rem; }
.month-detail { font-size:0.7rem; color:var(--text-muted); }
.stats-empty { text-align:center; color:var(--text-muted); padding:1.25rem 0 0.5rem; font-size:0.82rem; line-height:1.7; }
.stats-first-walk { text-align:center; padding:1.5rem 0.5rem 0.75rem; }
.stats-empty-icon { font-size:2.4rem; margin-bottom:0.5rem; display:block; }
.stats-empty-headline { font-family:'DM Serif Display',serif; font-size:1.1rem; color:var(--dark); margin-bottom:0.35rem; }
.stats-empty-body { font-size:0.8rem; color:var(--text-muted); line-height:1.6; margin-bottom:0.9rem; }

.new-route-btn { width:100%; padding:0.75rem; border-radius:11px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.86rem; cursor:pointer; margin:0.5rem auto; display:block; max-width:480px; -webkit-tap-highlight-color:transparent; position:relative; z-index:1; min-height:44px; }
.new-route-btn:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }

/* ‚îÄ‚îÄ END WALK MODAL ‚îÄ‚îÄ */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:500; display:flex; align-items:flex-end; justify-content:center; padding:1rem; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); opacity:0; pointer-events:none; transition:opacity 0.2s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal-sheet { background:var(--card); border:1px solid var(--card-border); border-radius:20px 20px 16px 16px; padding:1.4rem 1.25rem calc(1.25rem + env(safe-area-inset-bottom)); max-width:440px; width:100%; transform:translateY(30px); transition:transform 0.25s cubic-bezier(0.34,1.2,0.64,1); }
.modal-overlay.open .modal-sheet { transform:translateY(0); }
.modal-title { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); margin-bottom:0.35rem; text-align:center; }
.modal-body  { font-size:0.82rem; color:var(--text-sub); text-align:center; line-height:1.55; margin-bottom:1.1rem; }
.modal-btns  { display:flex; flex-direction:column; gap:0.5rem; }
.modal-confirm { padding:0.8rem; border-radius:12px; border:none; background:var(--danger); color:#fff; font-family:'DM Serif Display',serif; font-size:1rem; cursor:pointer; min-height:48px; }
.modal-cancel  { padding:0.7rem; border-radius:12px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.88rem; cursor:pointer; min-height:44px; }

/* ‚îÄ‚îÄ GLOBAL ERROR BANNER ‚îÄ‚îÄ */
.error-banner { display:none; background:#c85050; color:#fff; font-size:0.8rem; padding:0.6rem 1rem; text-align:center; position:fixed; top:0; left:0; right:0; z-index:9999; padding-top:calc(0.6rem + env(safe-area-inset-top)); }

/* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
.onboard-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; display:flex; align-items:flex-end; justify-content:center; padding:1rem; backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); }
.onboard-overlay.hidden { display:none; }
.onboard-sheet { background:var(--card); border-radius:24px 24px 20px 20px; padding:1.8rem 1.5rem calc(1.5rem + env(safe-area-inset-bottom)); max-width:440px; width:100%; animation:slideUp 0.35s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideUp { from{transform:translateY(50px);opacity:0} to{transform:translateY(0);opacity:1} }
.onboard-dots { display:flex; justify-content:center; gap:0.4rem; margin-bottom:1.2rem; }
.onboard-dot { width:6px; height:6px; border-radius:50%; background:var(--mid); transition:all 0.25s; }
.onboard-dot.active { background:var(--primary); width:20px; border-radius:3px; }
.onboard-icon { font-size:3rem; text-align:center; margin-bottom:0.75rem; }
.onboard-title { font-family:'DM Serif Display',serif; font-size:1.55rem; color:var(--dark); text-align:center; margin-bottom:0.4rem; line-height:1.2; }
.onboard-body { font-size:0.84rem; color:var(--text-sub); text-align:center; line-height:1.65; margin-bottom:1.3rem; }
.onboard-next { width:100%; padding:0.9rem; border-radius:13px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.05rem; cursor:pointer; -webkit-tap-highlight-color:transparent; min-height:48px; }
.onboard-skip { display:block; text-align:center; margin-top:0.6rem; font-size:0.78rem; color:var(--text-muted); cursor:pointer; background:none; border:none; width:100%; padding:0.4rem; font-family:'DM Sans',sans-serif; min-height:36px; }

/* ‚îÄ‚îÄ STATE TRANSITIONS ‚îÄ‚îÄ */
.card, .ready-card, .route-info, .recap-card { transition:opacity 0.25s ease, transform 0.25s ease; }
@keyframes slideInUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.slide-in { animation:slideInUp 0.3s ease forwards; }

/* ‚îÄ‚îÄ MAPS LOADING FALLBACK ‚îÄ‚îÄ */
.api-key-banner { background:var(--warm); border:1.5px solid var(--mid); border-radius:14px; padding:1rem 1.2rem; margin:0.5rem auto; max-width:480px; text-align:center; position:relative; z-index:1; display:none; }
.api-key-banner-title { font-family:'DM Serif Display',serif; font-size:1rem; color:var(--dark); margin-bottom:0.3rem; }
.api-key-banner-msg { font-size:0.78rem; color:var(--text-sub); line-height:1.5; }
.api-key-banner code { background:var(--mid); padding:0.1rem 0.35rem; border-radius:4px; font-size:0.72rem; }

@media (orientation:landscape) and (max-height:500px) {
  header { padding-top:0.5rem; padding-bottom:0; }
  .logo { font-size:1.6rem; }
  .tagline { display:none; }
  .top-bar { padding:0.2rem 1rem; }
  #main-map { height:min(240px,55svh); }
  .card { padding:1rem; margin:0.25rem auto; }
  .distance-display { font-size:2rem; }
  .onboard-sheet { padding:1rem 1.25rem; }
  .onboard-icon { font-size:2rem; margin-bottom:0.4rem; }
  .onboard-title { font-size:1.2rem; }
  .onboard-body { font-size:0.78rem; margin-bottom:0.8rem; }
  .theme-picker-wrap { top:0.4rem; }
}
@media (max-width:380px) {
  .logo { font-size:2rem; }
  .prefs-grid { gap:0.3rem; }
  .pref-chip { padding:0.35rem 0.65rem; font-size:0.75rem; }
  .distance-display { font-size:2.4rem; }
  .theme-btn { font-size:0.75rem; }
}
</style>
</head>
<body>

<!-- Global error banner -->
<div class="error-banner" id="error-banner"></div>

<!-- End walk modal -->
<div class="modal-overlay" id="end-walk-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-sheet">
    <div class="modal-title" id="modal-title">End walk early?</div>
    <div class="modal-body">Your distance walked will be saved, but you need 65% of the route to earn your streak.</div>
    <div class="modal-btns">
      <button class="modal-confirm" onclick="confirmEndWalk()">End & save distance</button>
      <button class="modal-cancel"  onclick="closeEndWalkModal()">Keep walking</button>
    </div>
  </div>
</div>

<!-- Onboarding -->
<div class="onboard-overlay hidden" id="onboard-overlay">
  <div class="onboard-sheet">
    <div class="onboard-dots">
      <div class="onboard-dot active" id="od0"></div>
      <div class="onboard-dot" id="od1"></div>
      <div class="onboard-dot" id="od2"></div>
    </div>
    <div class="onboard-icon" id="onboard-icon">üó∫Ô∏è</div>
    <div class="onboard-title" id="onboard-title">Your neighborhood, explored</div>
    <div class="onboard-body" id="onboard-body">Walk Buddy generates a personalized loop route right from where you are. Pick a distance and go ‚Äî no planning needed.</div>
    <button class="onboard-next" id="onboard-next" onclick="nextOnboard()">Get Started ‚Üí</button>
    <button class="onboard-skip" onclick="closeOnboarding()">Skip intro</button>
  </div>
</div>

<header>
  <div class="logo">Walk <span>Buddy</span></div>
  <div class="tagline" id="tagline" aria-live="polite">Ready to explore?</div>
  <div class="theme-picker-wrap" role="group" aria-label="Choose theme">
    <div class="theme-picker">
      <button class="theme-btn" data-theme="forest" onclick="setTheme('forest')" aria-label="Forest theme" title="Forest">üåø</button>
      <button class="theme-btn" data-theme="ocean"  onclick="setTheme('ocean')"  aria-label="Ocean theme"  title="Ocean">üåä</button>
      <button class="theme-btn" data-theme="city"   onclick="setTheme('city')"   aria-label="City theme"   title="City">üåÜ</button>
      <button class="theme-btn" data-theme="bloom"  onclick="setTheme('bloom')"  aria-label="Bloom theme"  title="Bloom">üå∏</button>
    </div>
  </div>
</header>

<div class="top-bar" role="status" aria-label="Current conditions and streak">
  <div class="top-pill" id="weather-pill" aria-label="Current weather">
    <span class="pill-icon" aria-hidden="true">üå§Ô∏è</span>
    <span id="weather-text"><span class="weather-shimmer" aria-hidden="true"></span></span>
  </div>
  <div class="top-pill streak-pill" id="streak-pill" aria-label="Walking streak">
    <span class="pill-icon" id="streak-icon" aria-hidden="true">üö∂</span>
    <div>
      <div id="streak-text">Start your streak today</div>
      <div class="pill-sub" id="streak-sub">Go on your first walk!</div>
    </div>
  </div>
</div>

<!-- API key banner (shown if key is placeholder) -->
<div class="api-key-banner" id="api-key-banner">
  <div class="api-key-banner-title">‚ö†Ô∏è Google Maps API Key Needed</div>
  <div class="api-key-banner-msg">
    Replace <code>AIzaSyBxYn-xfG-fNzztVsos0RCsa-SBKHv2yTM_HERE</code> at the bottom of the HTML with a valid Google Maps API key.<br>
    Enable <strong>Maps JS API</strong>, <strong>Directions API</strong>, <strong>Places API</strong>, and <strong>Geocoding API</strong>.
  </div>
</div>

<!-- Route error card -->
<div class="error-card" id="error-card">
  <div class="error-card-icon">üòï</div>
  <div class="error-card-title" id="error-card-title">Couldn't build that route</div>
  <div class="error-card-msg" id="error-card-msg">We couldn't find a suitable route nearby. Try a shorter distance or different preferences.</div>
  <button class="error-card-retry" onclick="resetPlanner()">‚Ü© Try Again</button>
</div>

<!-- Planner -->
<div class="card" id="planner-card">
  <div class="section-label">How far do you want to walk?</div>
  <div class="distance-display" id="dist-display">1.5 <span id="dist-unit-label">miles</span></div>
  <div class="walk-time-est" id="walk-time-est">About 30 min</div>
  <input type="range" id="dist-slider" min="0.5" max="5" step="0.5" value="1.5"
         aria-label="Walking distance" aria-valuetext="1.5 miles">
  <div class="range-labels"><span>0.5</span><span>5</span></div>
  <div class="dist-presets" role="group" aria-label="Distance presets">
    <button class="dist-preset" onclick="setPreset(1)"   aria-label="1 mile preset">1 mi</button>
    <button class="dist-preset" onclick="setPreset(2)"   aria-label="2 miles preset">2 mi</button>
    <button class="dist-preset" onclick="setPreset(3)"   aria-label="3 miles preset">3 mi</button>
    <button class="dist-preset" onclick="setPreset(5)"   aria-label="5 miles preset">5 mi</button>
  </div>
  <div class="toggles-row">
    <div class="toggle-group">
      <span>Distance:</span>
      <button id="btn-miles" class="active" onclick="setUnit('miles')" aria-pressed="true">Miles</button>
      <button id="btn-km"    onclick="setUnit('km')"    aria-pressed="false">KM</button>
    </div>
    <div class="toggle-group">
      <span>Temp:</span>
      <button id="btn-f" class="active" onclick="setTemp('f')" aria-pressed="true">¬∞F</button>
      <button id="btn-c" onclick="setTemp('c')" aria-pressed="false">¬∞C</button>
    </div>
  </div>

  <div style="margin-top:1.2rem">
    <div class="label-row">
      <div class="section-label">What do you want to pass by?</div>
      <div class="tooltip-wrap">
        <button class="info-btn" aria-label="How preferences work" aria-expanded="false" onclick="toggleTooltip(this)">?</button>
        <div class="tooltip-box" role="tooltip">Your route will detour past a matching spot for each category you pick. Up to 3 stops are included. If nothing's found nearby, a scenic loop is generated instead.</div>
      </div>
    </div>
    <div class="prefs-grid" role="group" aria-label="Route preferences">
      <button class="pref-chip" data-pref="park"       onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üå≥</span> Park</button>
      <button class="pref-chip" data-pref="coffee"     onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">‚òï</span> Coffee</button>
      <button class="pref-chip" data-pref="bookstore"  onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üìö</span> Bookstore</button>
      <button class="pref-chip" data-pref="shops"      onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üõçÔ∏è</span> Shops</button>
      <button class="pref-chip" data-pref="restaurant" onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üçú</span> Restaurant</button>
      <button class="pref-chip" data-pref="nature"     onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üåø</span> Nature</button>
      <button class="pref-chip" data-pref="art"        onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üé®</span> Art / Murals</button>
      <button class="pref-chip" data-pref="water"      onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">üåä</span> Water</button>
      <button class="pref-chip" data-pref="quiet"      onclick="togglePref(this)" aria-pressed="false"><span class="icon" aria-hidden="true">ü§´</span> Quiet streets</button>
    </div>
    <div class="pref-counter" id="pref-counter" aria-live="polite"></div>
  </div>

  <div class="crazy-toggle-wrap">
    <label class="crazy-toggle" id="crazy-toggle">
      <input type="checkbox" id="crazy-check" onchange="toggleCrazyMode(this.checked)">
      <div class="crazy-track"><div class="crazy-thumb"></div></div>
      <div class="crazy-label">
        <div class="crazy-label-main"><span class="crazy-emoji">ü§™</span> Crazy Mode</div>
        <div class="crazy-label-sub">Zigzag through side streets & neighborhoods</div>
      </div>
    </label>
  </div>

  <button class="generate-btn ripple-wrap" id="generate-btn" onclick="generateRoute()" disabled aria-label="Generate walking route" aria-describedby="generate-waiting-msg">
    <span aria-hidden="true">üó∫Ô∏è</span> <span id="generate-btn-label">Generate My Walk</span>
  </button>
  <div class="generate-waiting" id="generate-waiting-msg" aria-live="polite">Waiting for your location‚Ä¶</div>
</div>

<!-- Map -->
<div class="map-wrap">
  <div id="main-map" role="img" aria-label="Walking route map">
    <div class="map-placeholder" id="map-placeholder">
      <span class="map-ph-icon">üó∫Ô∏è</span>
      Loading map‚Ä¶
    </div>
  </div>
  <div class="gps-badge" id="gps-badge">
    <div class="gps-badge-dot locating" id="gps-badge-dot"></div>
    <span class="gps-badge-text" id="gps-badge-text">Locating‚Ä¶</span>
  </div>
  <div class="map-denied-overlay" id="map-denied-overlay">
    <div class="map-denied-icon">üîí</div>
    <div class="map-denied-title">Location blocked</div>
    <div class="map-denied-sub" id="map-denied-sub">Enable location in your browser settings to generate a route.</div>
    <button class="map-denied-btn" onclick="doRequestLocation()">Try Again</button>
  </div>
  <div class="loading-box" id="loading-box" role="status" aria-live="polite">
    <div class="walk-anim" aria-hidden="true">üö∂</div>
    <div class="loading-text" id="loading-text">Building your route‚Ä¶</div>
    <div class="loading-sub"  id="loading-sub">Finding spots nearby‚Ä¶</div>
    <div class="loading-progress"><div class="loading-progress-bar"></div></div>
  </div>
  <button class="map-lock-btn locked" id="map-lock-btn" onclick="toggleMapLock()" aria-label="Toggle map follow mode">üìç Following</button>
</div>

<!-- Location permission prompt -->
<div class="location-prompt" id="location-prompt">
  <div class="lp-row">
    <div class="lp-emoji" aria-hidden="true">üìç</div>
    <div class="lp-content">
      <div class="lp-headline">Allow your location</div>
      <div class="lp-desc">Walk Buddy builds a personalized loop from exactly where you are. Your location is never stored or shared.</div>
    </div>
    <button class="lp-allow-btn" onclick="doRequestLocation()">Allow ‚Üí</button>
  </div>
</div>

<!-- Route distance mismatch -->
<div class="dist-mismatch" id="dist-mismatch" role="status" aria-live="polite"></div>

<!-- Turn banner -->
<div class="turn-banner" id="turn-banner" role="status" aria-live="polite">
  <div class="turn-arrow" id="turn-arrow" aria-hidden="true">‚Üë</div>
  <div class="turn-text">
    <div class="turn-instruction" id="turn-instruction">Follow the route</div>
    <div class="turn-dist" id="turn-dist"></div>
  </div>
  <div class="turn-timer" id="nav-timer" aria-label="Elapsed time">0:00</div>
</div>

<!-- Route info -->
<div class="route-info" id="route-info-wrap" aria-label="Route details">
  <div class="route-pills" id="route-pills"></div>
  <div class="spots-list" id="spots-list"></div>
</div>

<!-- Ready to walk -->
<div class="ready-card" id="ready-card" role="dialog" aria-label="Ready to walk">
  <div class="ready-title">Ready to walk? üö∂</div>
  <div class="ready-sub" id="ready-sub">Your route is set. Let's go!</div>
  <div class="ready-btns">
    <button class="ready-yes ripple-wrap" onclick="startWalking()">Yes, let's go!</button>
    <button class="ready-no"  onclick="saveRouteForLater()">Save route</button>
  </div>
  <button class="ready-cancel" onclick="resetPlanner()">‚úï Cancel route</button>
</div>

<!-- Saved route bar -->
<div class="saved-route-bar" id="saved-route-bar">
  <span class="saved-route-label">Route saved ‚Äî ready when you are</span>
  <button class="saved-route-start" onclick="startWalking()">Start Walk ‚Üí</button>
</div>

<!-- Suspended banner -->
<div class="suspended-banner" id="suspended-banner" role="alert">
  ‚ö†Ô∏è Walk paused ‚Äî tracking resumed. Distance and time may be slightly off.
</div>

<!-- Nav stats -->
<div class="nav-stats-wrap" id="nav-stats-wrap" aria-label="Walk progress">
  <div class="nav-progress-wrap">
    <div class="nav-progress-bar" id="nav-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <div class="nav-stats">
    <div class="ns"><div class="nv" id="n-dist">0.0</div><div class="nl" id="n-dist-label">Miles</div></div>
    <div class="ns"><div class="nv" id="n-steps">0</div><div class="nl">Steps</div></div>
    <div class="ns"><div class="nv" id="n-pct">0%</div><div class="nl">Done</div></div>
    <div class="ns"><div class="nv" id="n-time">0:00</div><div class="nl">Time</div></div>
  </div>
  <div class="walk-actions">
    <button class="pause-btn" id="pause-btn" onclick="togglePause()" aria-label="Pause walk">‚è∏ Pause</button>
    <button class="cancel-btn" onclick="cancelWalk()" aria-label="Cancel walk">‚úï Cancel</button>
    <button class="voice-btn" id="voice-btn" onclick="toggleVoice()" aria-label="Toggle voice guidance" title="Voice guidance">üîá</button>
  </div>
  <div class="complete-wrap">
    <button class="complete-btn" id="complete-btn" onclick="completeWalk()" disabled aria-label="Complete walk" aria-disabled="true">
      Complete Walk ‚úÖ
      <div class="complete-progress-fill" id="complete-progress-fill" style="width:0%"></div>
    </button>
  </div>
  <div class="complete-hint" id="complete-hint" aria-live="polite">Walk 65% of your route to unlock</div>
  <button class="end-walk-btn" onclick="showEndWalkModal()" aria-label="End walk without saving streak">End walk (save distance only)</button>
</div>

<!-- Walk Recap -->
<div class="recap-card" id="recap-card">
  <div class="recap-confetti" id="recap-confetti"></div>
  <div class="recap-hero">
    <div class="recap-hero-dist" id="recap-hero-dist">0.0</div>
    <div class="recap-hero-unit" id="recap-hero-unit">miles walked</div>
    <div class="recap-hero-streak" id="recap-hero-streak"></div>
  </div>
  <div class="recap-title" id="recap-title">Walk complete! üéâ</div>
  <div class="recap-subtitle" id="recap-subtitle"></div>
  <div class="recap-stats">
    <div class="recap-stat"><div class="rv" id="recap-steps">0</div><div class="rl">Steps</div></div>
    <div class="recap-stat"><div class="rv" id="recap-time">0:00</div><div class="rl">Time</div></div>
  </div>
  <div class="recap-actions">
    <button class="recap-new"   onclick="resetPlanner()">‚Ü© New Walk</button>
    <button class="recap-share" onclick="shareRecap()">Share üì§</button>
  </div>
</div>

<!-- Streak banner -->
<div class="streak-banner" id="streak-banner" role="status" aria-live="polite">
  <div class="streak-num" id="streak-banner-num"></div>
  <div class="streak-msg" id="streak-banner-msg"></div>
</div>

<!-- Stats -->
<div class="card stats-card" id="stats-card">
  <div class="stats-header">
    <div class="section-label" style="margin:0">Your Stats</div>
    <div class="stats-tabs" role="tablist">
      <button class="stats-tab active" role="tab" aria-selected="true"  onclick="showStats('month',this)">Month</button>
      <button class="stats-tab"        role="tab" aria-selected="false" onclick="showStats('year',this)">Year</button>
      <button class="stats-tab"        role="tab" aria-selected="false" onclick="showStats('history',this)">History</button>
    </div>
  </div>
  <div id="stats-content" role="tabpanel"></div>
</div>

<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ñ∏ SERVICE CONFIGURATION
   ‚ñ∏ Replace placeholder values with your real credentials.
   ‚ñ∏ All services degrade gracefully ‚Äî the app works without them.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SERVICES_CONFIG = {
  supabase: {
    url:  'https://yorhniboaldmrvgebdmp.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvcmhuaWJvYWxkbXJ2Z2ViZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTg1ODgsImV4cCI6MjA4NzUzNDU4OH0.UedKTMD5WlfLUJPASVwVF68H-0x9lCoDqSS92Be0aiI',
  },
  sentry: {
    dsn: 'https://c5f304b04deb57d5c6a8c5ccb5db419a@o4510942446092288.ingest.us.sentry.io/4510942627889152',
  },
  posthog: {
    apiKey:  'phc_kYH8kOBigkr7O1Q1w2wgkAxSlWd9ytAFVBKe3jvAiVF',
    apiHost: 'https://us.i.posthog.com',
  },
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ñ∏ SERVICE INITIALIZATION
   ‚ñ∏ Each service initializes only if real credentials are provided.
   ‚ñ∏ Helpers are no-ops when a service isn't configured.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ SENTRY (error tracking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sentryReady = false;
function _initSentry() {
  try {
    if (SERVICES_CONFIG.sentry.dsn.startsWith('YOUR_')) return;
    if (typeof Sentry === 'undefined') return;
    Sentry.init({
      dsn: SERVICES_CONFIG.sentry.dsn,
      integrations: [Sentry.browserTracingIntegration()],
      tracesSampleRate: 0.3,
      environment: location.hostname === 'localhost' ? 'development' : 'production',
      beforeSend(event) {
        if (event.extra) { delete event.extra.lat; delete event.extra.lng; }
        return event;
      },
    });
    Sentry.setTag('app', 'walk-buddy');
    _sentryReady = true;
    console.log('‚úì Sentry initialized');
  } catch(e) { console.warn('Sentry init skipped:', e.message); }
}

function trackError(error, context = {}) {
  console.error(error, context);
  if (_sentryReady) {
    Sentry.withScope(scope => {
      Object.entries(context).forEach(([k, v]) => scope.setExtra(k, v));
      Sentry.captureException(error instanceof Error ? error : new Error(String(error)));
    });
  }
}
function addBreadcrumb(category, message, data = {}) {
  if (_sentryReady) Sentry.addBreadcrumb({ category, message, data, level: 'info' });
}

// ‚îÄ‚îÄ POSTHOG (analytics) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _posthogReady = false;
function _initPostHog() {
  try {
    if (SERVICES_CONFIG.posthog.apiKey.startsWith('YOUR_')) return;
    if (typeof posthog === 'undefined' || !posthog.init) return;
    posthog.init(SERVICES_CONFIG.posthog.apiKey, {
      api_host: SERVICES_CONFIG.posthog.apiHost,
      capture_pageview: true,
      capture_pageleave: true,
      autocapture: false,
      persistence: 'localStorage',
      loaded: () => { _posthogReady = true; console.log('‚úì PostHog initialized'); },
    });
  } catch(e) { console.warn('PostHog init skipped:', e.message); }
}

function trackEvent(name, props = {}) {
  if (_posthogReady) posthog.capture(name, props);
  addBreadcrumb('event', name, props);
}

// ‚îÄ‚îÄ SUPABASE (backend data persistence) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _supaClient = null;
let _supaReady = false;
let _supaUser = null;

async function _initSupabase() {
  try {
    if (SERVICES_CONFIG.supabase.url.startsWith('YOUR_')) return;
    if (typeof supabase === 'undefined' || !supabase.createClient) return;
    _supaClient = supabase.createClient(
      SERVICES_CONFIG.supabase.url,
      SERVICES_CONFIG.supabase.anonKey,
    );

    const { data: { session } } = await _supaClient.auth.getSession();
    if (!session) {
      const { data, error } = await _supaClient.auth.signInAnonymously();
      if (error) throw error;
      _supaUser = data.user;
    } else {
      _supaUser = session.user;
    }
    _supaReady = true;
    console.log('‚úì Supabase initialized (user:', _supaUser?.id?.slice(0,8) + '‚Ä¶)');
    _syncLocalToSupabase();
  } catch(e) { console.warn('Supabase init skipped:', e.message); }
}

// ‚îÄ‚îÄ DEFERRED SERVICE INIT (wait for async scripts to load) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _initAllServices() {
  _initSentry();
  _initPostHog();
  _initSupabase();
}
// Try immediately, then retry after scripts have had time to load
_initAllServices();
setTimeout(_initAllServices, 2000);
setTimeout(_initAllServices, 5000);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ñ∏ WalkBuddyDB ‚Äî Data Abstraction Layer
   ‚ñ∏ Writes to both localStorage (instant) and Supabase (async sync).
   ‚ñ∏ Reads from localStorage first for speed, syncs from Supabase
   ‚ñ∏ when available for cross-device persistence.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WalkBuddyDB = {
  // ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ
  async getStreak() {
    try {
      const raw = localStorage.getItem('wb_streak');
      if (!raw) return {count:0, lastWalkDate:null, totalWalks:0, totalMiles:0};
      const d = JSON.parse(raw);
      if (!d.lastWalkDate && d.lastWalk) d.lastWalkDate = d.lastWalk;
      if (typeof d.totalWalks !== 'number') d.totalWalks = 0;
      if (typeof d.totalMiles !== 'number') d.totalMiles = 0;
      return d;
    } catch(e) { return {count:0, lastWalkDate:null, totalWalks:0, totalMiles:0}; }
  },

  async saveStreak(d) {
    try { localStorage.setItem('wb_streak', JSON.stringify(d)); } catch(e) {}
    if (_supaReady) {
      try {
        await _supaClient.from('walk_streaks').upsert({
          user_id: _supaUser.id,
          count: d.count,
          last_walk_date: d.lastWalkDate,
          total_walks: d.totalWalks,
          total_miles: d.totalMiles,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id' });
      } catch(e) { trackError(e, {context: 'saveStreak'}); }
    }
  },

  // ‚îÄ‚îÄ WALK LOG ‚îÄ‚îÄ
  getWalkLog() {
    try { return JSON.parse(localStorage.getItem('wb_walklog') || '[]'); } catch(e) { return []; }
  },

  async logWalk(entry) {
    const log = this.getWalkLog();
    log.push(entry);
    try { localStorage.setItem('wb_walklog', JSON.stringify(log)); } catch(e) {}
    if (_supaReady) {
      try {
        await _supaClient.from('walk_logs').insert({
          user_id: _supaUser.id,
          date: entry.date,
          miles: entry.miles,
          steps: entry.steps,
          month: entry.month,
          year: entry.year,
        });
      } catch(e) { trackError(e, {context: 'logWalk'}); }
    }
  },

  // ‚îÄ‚îÄ PREFERENCES (theme, unit, temp, etc.) ‚îÄ‚îÄ
  getPref(key, fallback = null) {
    try { return localStorage.getItem(key) ?? fallback; } catch(e) { return fallback; }
  },

  async setPref(key, value) {
    try { localStorage.setItem(key, value); } catch(e) {}
    if (_supaReady) {
      try {
        await _supaClient.from('user_prefs').upsert({
          user_id: _supaUser.id,
          key, value,
          updated_at: new Date().toISOString(),
        }, { onConflict: 'user_id,key' });
      } catch(e) { /* silent ‚Äî prefs are low priority */ }
    }
  },
};

// ‚îÄ‚îÄ SUPABASE DATA SYNC (local ‚Üí cloud on first connect) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function _syncLocalToSupabase() {
  if (!_supaReady) return;
  try {
    // Check if user already has cloud data
    const { data: existing } = await _supaClient
      .from('walk_streaks')
      .select('user_id')
      .eq('user_id', _supaUser.id)
      .maybeSingle();

    if (existing) return; // Already synced, don't overwrite

    // Push local streak to cloud
    const streak = await WalkBuddyDB.getStreak();
    if (streak.totalWalks > 0) await WalkBuddyDB.saveStreak(streak);

    // Push local walk log to cloud
    const log = WalkBuddyDB.getWalkLog();
    if (log.length > 0 && _supaClient) {
      const rows = log.map(e => ({
        user_id: _supaUser.id, date: e.date, miles: e.miles,
        steps: e.steps, month: e.month, year: e.year,
      }));
      await _supaClient.from('walk_logs').insert(rows);
    }
    console.log('‚úì Local data synced to Supabase');
  } catch(e) { console.warn('Sync skipped:', e.message); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ñ∏ GOOGLE MAPS API KEY
   ‚ñ∏ Replace 'AIzaSyBxYn-xfG-fNzztVsos0RCsa-SBKHv2yTM_HERE' with your real key.
   ‚ñ∏ Required APIs: Maps JS, Directions, Places, Geocoding
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GOOGLE_MAPS_API_KEY = 'AIzaSyAmPC9JsJksWZWaFtHARyoHjMpG9qV-x48';

// ‚îÄ‚îÄ GLOBAL ERROR HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onerror = (msg, src, line, col, err) => {
  trackError(err || msg, {source: src, line, col});
  if (src && src.includes('maps.googleapis.com')) return false;
  showErrorBanner('Something went wrong. Try refreshing the page.');
  return false;
};
window.onunhandledrejection = e => {
  trackError(e.reason || 'Unhandled promise rejection', {type: 'unhandledrejection'});
};
function showErrorBanner(msg) {
  const b = document.getElementById('error-banner');
  if (!b) return;
  b.textContent = msg;
  b.style.display = 'block';
  setTimeout(() => { b.style.display = 'none'; }, 6000);
}

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FALLBACK_CENTER = {lat:34.0900, lng:-118.3617};
const prefToType = {park:'park',coffee:'cafe',bookstore:'book_store',shops:'clothing_store',restaurant:'restaurant',nature:'park',art:'art_gallery',water:'natural_feature',quiet:null};
const prefEmoji  = {park:'üå≥',coffee:'‚òï',bookstore:'üìö',shops:'üõçÔ∏è',restaurant:'üçú',nature:'üåø',art:'üé®',water:'üåä',quiet:'ü§´'};
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const LOADING_PHRASES = ['Checking what\'s nearby‚Ä¶','Mapping your loop‚Ä¶','Finding interesting spots‚Ä¶','Plotting the best path‚Ä¶','Almost ready‚Ä¶'];
const CRAZY_LOADING_PHRASES = ['Going off the beaten path‚Ä¶','Zigzagging through alleys‚Ä¶','Finding weird side streets‚Ä¶','Making this route WILD‚Ä¶','Embracing the chaos‚Ä¶','Plotting maximum adventure‚Ä¶','Almost done being crazy‚Ä¶'];
const STEPS_PER_MILE = 2200;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userCenter = null, locationReady = false, isGenerating = false, isWalking = false;
let mapsReady = false; // true once Google Maps JS has loaded
let useKm = false, useCelsius = false;
let map, directionsService, directionsRenderer, placesService;
let actualRouteMiles = 0, requestedMiles = 1.5;
let allSteps = [], routeStepCumulativeMiles = [];
let currentStepIndex = 0, lastDirectionsResult = null;
const selectedPrefs = new Set();
const MAX_PREFS = 3;
let crazyMode = false;

let walkDistanceMiles = 0, walkStartTime = null, walkTimerInterval = null;
let geoWatchId = null, idleWatchId = null;
let lastGeoPos = null, lastHeading = null;
let isPaused = false, walkUnlocked = false, userMarker = null, walkedPath = null;
let finalWalkTime = '0:00';
let mapLocked = true;
let voiceEnabled = false;

let _gpsReadingBuffer = [];
const GPS_CONFIDENCE_REQUIRED = 3;
let _accelStepCount = 0, _accelLastPeak = 0, _accelBuffer = [], _usingAccelerometer = false;
let _rafPending = false, _pendingNavUpdate = null;
let _loadingPhraseInterval = null;

// ‚îÄ‚îÄ WALK STATE AUTO-SAVE & RECOVERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveWalkState() {
  if (!isWalking) return;
  try {
    localStorage.setItem('wb_walk_inprogress', JSON.stringify({
      distanceMiles: walkDistanceMiles, startTime: walkStartTime,
      pausedMs: window._totalPausedMs || 0, routeMiles: actualRouteMiles,
      stepIndex: currentStepIndex, accelSteps: _accelStepCount, ts: Date.now()
    }));
  } catch(e) {}
}
function checkWalkRecovery() {
  try {
    const saved = JSON.parse(localStorage.getItem('wb_walk_inprogress') || 'null');
    if (!saved) return;
    if (Date.now() - saved.ts > 10 * 60 * 1000) { localStorage.removeItem('wb_walk_inprogress'); return; }
    if (saved.distanceMiles > 0.1) {
      logWalkStats(saved.distanceMiles.toFixed(2));
      showStats('month', document.querySelector('.stats-tab.active'));
    }
    localStorage.removeItem('wb_walk_inprogress');
  } catch(e) {}
}

// ‚îÄ‚îÄ PAGE VISIBILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _bgTime = null;
window._totalPausedMs = 0;
document.addEventListener('visibilitychange', () => {
  if (document.hidden) { _bgTime = Date.now(); saveWalkState(); }
  else {
    if (_bgTime && isWalking) {
      const gapMs = Date.now() - _bgTime;
      if (gapMs > 5000) {
        window._totalPausedMs += gapMs;
        if (!isPaused) walkStartTime += gapMs;
        const b = document.getElementById('suspended-banner');
        if (b) { b.style.display = 'block'; setTimeout(() => b.style.display = 'none', 4000); }
        lastGeoPos = null; _gpsReadingBuffer = [];
      }
    }
    _bgTime = null;
  }
});

// ‚îÄ‚îÄ PERMISSION CHECK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkLocationPermission() {
  if (!navigator.permissions) return 'unknown';
  try { const r = await navigator.permissions.query({name:'geolocation'}); return r.state; }
  catch(e) { return 'unknown'; }
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(t) {
  document.body.setAttribute('data-theme', t === 'forest' ? '' : t);
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === t));
  try { localStorage.setItem('wb_theme', t); } catch(e) {}
  trackEvent('theme_changed', {theme: t});
}
(function(){
  try {
    const t = localStorage.getItem('wb_theme') || 'forest';
    document.body.setAttribute('data-theme', t === 'forest' ? '' : t);
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === t));
  } catch(e) {}
})();

// ‚îÄ‚îÄ UNITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setUnit(u) {
  useKm = u === 'km';
  document.getElementById('btn-miles').classList.toggle('active', !useKm);
  document.getElementById('btn-km').classList.toggle('active', useKm);
  document.getElementById('btn-miles').setAttribute('aria-pressed', String(!useKm));
  document.getElementById('btn-km').setAttribute('aria-pressed', String(useKm));
  const nl = document.getElementById('n-dist-label'); if (nl) nl.textContent = useKm ? 'Km' : 'Miles';
  updateDistDisplay();
  try { localStorage.setItem('wb_unit', u); } catch(e) {}
}
function setTemp(t) {
  useCelsius = t === 'c';
  document.getElementById('btn-f').classList.toggle('active', !useCelsius);
  document.getElementById('btn-c').classList.toggle('active', useCelsius);
  document.getElementById('btn-f').setAttribute('aria-pressed', String(!useCelsius));
  document.getElementById('btn-c').setAttribute('aria-pressed', String(useCelsius));
  try { localStorage.setItem('wb_temp', t); } catch(e) {}
  if (userCenter) fetchWeather(userCenter.lat, userCenter.lng);
}
function milesToDisplay(m) { return useKm ? (m*1.60934).toFixed(1) : parseFloat(m).toFixed(1); }
function unitLabel() { return useKm ? 'km' : 'miles'; }
function updateDistDisplay() {
  const v = parseFloat(document.getElementById('dist-slider').value);
  document.getElementById('dist-display').innerHTML = `${milesToDisplay(v)} <span id="dist-unit-label">${unitLabel()}</span>`;
  const mins = useKm ? Math.round(v * 1.60934 * 12) : Math.round(v * 20);
  document.getElementById('walk-time-est').textContent = `About ${mins} min`;
  if (isWalking) document.getElementById('n-dist').textContent = milesToDisplay(walkDistanceMiles);
  updateGenerateLabel();
}
(function(){
  try { const u = localStorage.getItem('wb_unit'); if (u) setUnit(u); } catch(e) {}
  try { const t = localStorage.getItem('wb_temp'); if (t) setTemp(t); } catch(e) {}
})();

// ‚îÄ‚îÄ DYNAMIC GENERATE BUTTON LABEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateGenerateLabel() {
  const btn = document.getElementById('generate-btn-label');
  if (!btn) return;
  const prefix = crazyMode ? 'ü§™ ' : '';
  if (selectedPrefs.size === 0) { btn.textContent = prefix + (crazyMode ? 'Generate Crazy Walk' : 'Generate My Walk'); return; }
  const labels = {park:'Park',coffee:'Coffee',bookstore:'Bookstore',shops:'Shops',restaurant:'Food',nature:'Nature',art:'Art',water:'Water',quiet:'Quiet'};
  const names = [...selectedPrefs].slice(0,2).map(p => labels[p] || p);
  btn.textContent = prefix + `Generate My ${names.join(' + ')} Walk`;
}

function toggleCrazyMode(on) {
  crazyMode = on;
  trackEvent('crazy_mode_toggled', {enabled: on});
  const card = document.getElementById('planner-card');
  if (card) card.classList.toggle('crazy-active', on);
  updateGenerateLabel();
  try { localStorage.setItem('wb_crazy', on ? '1' : '0'); } catch(e) {}
}
// Restore crazy mode from storage
(function(){
  try {
    const saved = localStorage.getItem('wb_crazy') === '1';
    if (saved) {
      crazyMode = true;
      const cb = document.getElementById('crazy-check');
      if (cb) cb.checked = true;
      const card = document.getElementById('planner-card');
      if (card) card.classList.add('crazy-active');
    }
  } catch(e) {}
})();

// ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ONBOARD_STEPS = [
  {icon:'üó∫Ô∏è', title:'Your neighborhood, explored', body:'Walk Buddy generates a personalized loop route right from where you are. Pick a distance and go ‚Äî no planning needed.'},
  {icon:'üìç', title:'Pick what you pass by', body:'Coffee shops, parks, bookstores, murals ‚Äî tap what sounds good and your route will weave past them. Up to 3 stops per route.'},
  {icon:'üî•', title:'Build your streak', body:'Complete a walk every day to grow your streak. Your history and stats are saved automatically between sessions.'},
];
let onboardStep = 0;
function initOnboarding() {
  try { if (localStorage.getItem('wb_onboarded')) return; } catch(e) {}
  document.getElementById('onboard-overlay').classList.remove('hidden');
}
function nextOnboard() {
  onboardStep++;
  if (onboardStep >= ONBOARD_STEPS.length) { closeOnboarding(); return; }
  const s = ONBOARD_STEPS[onboardStep];
  document.getElementById('onboard-icon').textContent = s.icon;
  document.getElementById('onboard-title').textContent = s.title;
  document.getElementById('onboard-body').textContent  = s.body;
  document.getElementById('onboard-next').textContent  = onboardStep === ONBOARD_STEPS.length-1 ? "Let's go! üö∂" : 'Next ‚Üí';
  for (let i=0;i<3;i++) { const d=document.getElementById('od'+i); if(d) d.classList.toggle('active',i===onboardStep); }
}
function closeOnboarding() {
  document.getElementById('onboard-overlay').classList.add('hidden');
  try { localStorage.setItem('wb_onboarded','1'); } catch(e) {}
  trackEvent('onboarding_completed', {step: onboardStep});
  showLocationPrompt(true);
  setGpsBadge('locating', 'Tap Allow to start');
}

// ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTooltip(btn) {
  const box = btn.nextElementSibling;
  const showing = box.classList.toggle('tooltip-visible');
  btn.setAttribute('aria-expanded', String(showing));
  if (showing) setTimeout(() => { box.classList.remove('tooltip-visible'); btn.setAttribute('aria-expanded','false'); }, 4000);
}

// ‚îÄ‚îÄ VOICE TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById('voice-btn');
  btn.textContent = voiceEnabled ? 'üîä' : 'üîá';
  btn.setAttribute('aria-label', voiceEnabled ? 'Voice guidance on ‚Äî tap to mute' : 'Voice guidance off ‚Äî tap to enable');
  try { localStorage.setItem('wb_voice', voiceEnabled ? '1' : '0'); } catch(e) {}
  if (!voiceEnabled) try { window.speechSynthesis.cancel(); } catch(e) {}
}
(function(){ try { voiceEnabled = localStorage.getItem('wb_voice') === '1'; document.getElementById('voice-btn').textContent = voiceEnabled ? 'üîä' : 'üîá'; } catch(e) {} })();

// ‚îÄ‚îÄ END WALK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEndWalkModal() { document.getElementById('end-walk-modal').classList.add('open'); }
function closeEndWalkModal() { document.getElementById('end-walk-modal').classList.remove('open'); }
function confirmEndWalk() { closeEndWalkModal(); _doEndWalkEarly(); }

// ‚îÄ‚îÄ STREAK (Supabase-backed with localStorage fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStreak() {
  // Synchronous read from localStorage for UI speed
  try {
    const raw = localStorage.getItem('wb_streak');
    if (!raw) return {count:0, lastWalkDate:null, totalWalks:0, totalMiles:0};
    const d = JSON.parse(raw);
    if (!d.lastWalkDate && d.lastWalk) d.lastWalkDate = d.lastWalk;
    if (typeof d.totalWalks !== 'number') d.totalWalks = 0;
    if (typeof d.totalMiles !== 'number') d.totalMiles = 0;
    return d;
  } catch(e) { return {count:0, lastWalkDate:null, totalWalks:0, totalMiles:0}; }
}
function saveStreak(d) {
  try { localStorage.setItem('wb_streak', JSON.stringify(d)); } catch(e) {}
  WalkBuddyDB.saveStreak(d); // async cloud sync
}
function recordWalk(miles) {
  const localDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const todayStr = localDate(new Date());
  const d = getStreak();
  d.totalWalks = (d.totalWalks || 0) + 1;
  d.totalMiles = (d.totalMiles || 0) + (parseFloat(miles) || 0);
  if (d.lastWalkDate === todayStr) { saveStreak(d); return d.count; }
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
  d.count = d.lastWalkDate === localDate(yesterday) ? d.count+1 : 1;
  d.lastWalkDate = todayStr;
  saveStreak(d);
  trackEvent('walk_recorded', {miles: parseFloat(miles), streak: d.count, totalWalks: d.totalWalks});
  return d.count;
}
function updateStreakUI() {
  const d = getStreak(), has = d.count >= 1;
  const pill = document.getElementById('streak-pill'), sub = document.getElementById('streak-sub');
  if (has) {
    document.getElementById('streak-text').textContent = `${d.count} day streak`;
    document.getElementById('streak-icon').textContent = 'üî•';
    sub.textContent = d.count >= 7 ? 'üèÜ 7 day goal reached!' : `${7-(d.count%7)} days to next milestone`;
    pill.classList.add('has-streak');
  } else {
    document.getElementById('streak-text').textContent = 'Start your streak today';
    document.getElementById('streak-icon').textContent = 'üö∂';
    sub.textContent = 'Go on your first walk!';
    pill.classList.remove('has-streak');
  }
}

// ‚îÄ‚îÄ WALK LOG (Supabase-backed with localStorage fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWalkLog() { return WalkBuddyDB.getWalkLog(); }
function logWalkStats(miles) {
  const now = new Date();
  const m = parseFloat(miles);
  const entry = {date:now.toISOString(), miles:m, steps:Math.round(m*STEPS_PER_MILE), month:now.getMonth(), year:now.getFullYear()};
  WalkBuddyDB.logWalk(entry); // writes localStorage + async Supabase
}
function showStats(view, btn) {
  document.querySelectorAll('.stats-tab').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
  if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
  const log = getWalkLog(), now = new Date(), c = document.getElementById('stats-content');
  const fmt = m => useKm ? (m*1.60934).toFixed(1)+' km' : m.toFixed(1)+' mi';
  const emptyState = (period) => `<div class="stats-first-walk">
    <span class="stats-empty-icon">üö∂</span>
    <div class="stats-empty-headline">No walks yet ${period}</div>
    <div class="stats-empty-body">Complete your first walk to see distance totals, step counts, and streak progress here.</div>
    <button class="stats-start-cta" onclick="document.getElementById('planner-card').scrollIntoView({behavior:'smooth'})">Plan a walk ‚Üë</button>
  </div>`;
  if (view === 'month') {
    const w = log.filter(x => x.month===now.getMonth() && x.year===now.getFullYear());
    if (w.length === 0) { c.innerHTML = emptyState(`in ${MONTHS[now.getMonth()]}`); return; }
    const miles = w.reduce((a,x)=>a+x.miles,0), steps = w.reduce((a,x)=>a+x.steps,0);
    c.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${MONTHS[now.getMonth()]} ${now.getFullYear()}</div>
    <div class="stats-big"><div class="sbb"><div class="sv">${fmt(miles)}</div><div class="sl">This month</div></div><div class="sbb"><div class="sv">${w.length}</div><div class="sl">Walk${w.length!==1?'s':''}</div></div></div>
    <div class="stats-small" style="margin-top:0.5rem"><div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div><div class="ssb"><div class="sv">${fmt(miles/w.length)}</div><div class="sl">Avg/walk</div></div></div>`;
  } else if (view === 'year') {
    const w = log.filter(x => x.year===now.getFullYear());
    if (w.length === 0) { c.innerHTML = emptyState(`in ${now.getFullYear()}`); return; }
    const miles = w.reduce((a,x)=>a+x.miles,0), steps = w.reduce((a,x)=>a+x.steps,0);
    c.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${now.getFullYear()} Total</div>
    <div class="stats-big"><div class="sbb"><div class="sv">${fmt(miles)}</div><div class="sl">This year</div></div><div class="sbb"><div class="sv">${w.length}</div><div class="sl">Walk${w.length!==1?'s':''}</div></div></div>
    <div class="stats-small" style="margin-top:0.5rem"><div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div><div class="ssb"><div class="sv">${fmt(miles/w.length)}</div><div class="sl">Avg/walk</div></div></div>`;
  } else {
    const grouped = {};
    log.forEach(x => { const k=`${x.year}-${x.month}`; if(!grouped[k]) grouped[k]={month:x.month,year:x.year,miles:0,steps:0,walks:0}; grouped[k].miles+=x.miles; grouped[k].steps+=x.steps; grouped[k].walks++; });
    const sorted = Object.values(grouped).sort((a,b) => b.year-a.year || b.month-a.month);
    c.innerHTML = sorted.length===0 ? emptyState('yet')
      : `<div class="month-history">${sorted.map(g=>`<div class="month-row"><div class="month-name">${MONTHS[g.month]} ${g.year}</div><div class="month-right"><div class="month-miles">${fmt(g.miles)}</div><div class="month-detail">${g.walks} walk${g.walks!==1?'s':''} ¬∑ ${g.steps.toLocaleString()} steps</div></div></div>`).join('')}</div>`;
  }
}

// ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWeather(lat, lng) {
  try {
    const unit = useCelsius ? 'celsius' : 'fahrenheit';
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=${unit}`);
    if (!r.ok) return;
    const d = await r.json();
    if (!d.current_weather) return;
    document.getElementById('weather-pill').querySelector('.pill-icon').textContent = weatherIcon(d.current_weather.weathercode);
    document.getElementById('weather-text').textContent = `${Math.round(d.current_weather.temperature)}¬∞${useCelsius?'C':'F'}`;
  } catch(e) { trackError(e, {context: 'weather_fetch'}); }
}
function weatherIcon(c) { if(c===0)return'‚òÄÔ∏è'; if(c<=2)return'üå§Ô∏è'; if(c===3)return'‚òÅÔ∏è'; if(c<=49)return'üå´Ô∏è'; if(c<=67)return'üåßÔ∏è'; if(c<=77)return'‚ùÑÔ∏è'; if(c<=82)return'üå¶Ô∏è'; return'‚õàÔ∏è'; }

// ‚îÄ‚îÄ CITY GEOCODER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectCityGeocoder(lat, lng) {
  if (!mapsReady) return;
  try {
    new google.maps.Geocoder().geocode({location:{lat,lng}}, (results, status) => {
      if (status==='OK' && results && results.length>0) {
        const addr = results[0].address_components;
        const city = addr.find(a=>a.types.includes('locality')) || addr.find(a=>a.types.includes('sublocality')) || addr.find(a=>a.types.includes('administrative_area_level_2'));
        const neighborhood = addr.find(a=>a.types.includes('neighborhood'));
        const display = neighborhood ? `${neighborhood.long_name}` : (city ? city.long_name : null);
        document.getElementById('tagline').textContent = display ? `${display} ¬∑ Discover your neighborhood` : 'Discover your neighborhood';
      } else { document.getElementById('tagline').textContent = 'Discover your neighborhood'; }
    });
  } catch(e) { document.getElementById('tagline').textContent = 'Discover your neighborhood'; }
}

// ‚îÄ‚îÄ LOCATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setGpsBadge(state, text) {
  const badge = document.getElementById('gps-badge');
  const dot   = document.getElementById('gps-badge-dot');
  const label = document.getElementById('gps-badge-text');
  if (!badge) return;
  if (state === 'hidden') { badge.classList.add('hidden'); return; }
  badge.classList.remove('hidden');
  dot.className = 'gps-badge-dot';
  if (state === 'locating') dot.classList.add('locating');
  else if (state === 'denied') dot.classList.add('denied');
  if (label) label.textContent = text || '';
}

function showLocationPrompt(visible) {
  const el = document.getElementById('location-prompt');
  if (el) el.style.display = visible ? 'block' : 'none';
}

function getLocationDeniedInstruction() {
  const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
  const isAndroid = /Android/.test(navigator.userAgent);
  if (isIOS) return 'Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Safari ‚Üí Allow';
  if (isAndroid) return 'Chrome menu ‚Üí Site Settings ‚Üí Location ‚Üí Allow';
  return 'Browser settings ‚Üí allow location for this site';
}

function showDeniedOverlay(instruction) {
  const overlay = document.getElementById('map-denied-overlay');
  const sub = document.getElementById('map-denied-sub');
  if (sub) sub.textContent = instruction || 'Enable location in your browser settings to generate a route.';
  if (overlay) overlay.classList.add('visible');
  setGpsBadge('denied', 'Location blocked');
}

function hideDeniedOverlay() {
  const overlay = document.getElementById('map-denied-overlay');
  if (overlay) overlay.classList.remove('visible');
}

function doRequestLocation() {
  if (locationReady) return;
  hideDeniedOverlay();
  showLocationPrompt(false);
  if (!navigator.geolocation) {
    setGpsBadge('denied', 'GPS unavailable');
    showErrorBanner('Geolocation is not supported by your browser.');
    return;
  }
  // Always attempt to acquire ‚Äî the browser will show its own prompt if needed
  _acquireLocation();
}

function _acquireLocation() {
  showLocationPrompt(false);
  hideDeniedOverlay();
  setGpsBadge('locating', 'Finding location‚Ä¶');
  document.getElementById('tagline').textContent = 'Finding your location‚Ä¶';
  const stages = ['Finding location‚Ä¶', 'Getting GPS fix‚Ä¶', 'Almost there‚Ä¶'];
  let si = 0;
  const stageTimer = setInterval(() => {
    si = Math.min(si+1, stages.length-1);
    setGpsBadge('locating', stages[si]);
  }, 3500);
  navigator.geolocation.getCurrentPosition(
    pos => {
      clearInterval(stageTimer);
      _gpsReadingBuffer = [{lat:pos.coords.latitude, lng:pos.coords.longitude, accuracy:pos.coords.accuracy}];
      userCenter = {lat:pos.coords.latitude, lng:pos.coords.longitude};
      onLocationReady();
      startIdleWatch();
    },
    err => {
      clearInterval(stageTimer);
      trackEvent('location_error', {code: err.code, message: err.message});
      if (err.code === 1) { // PERMISSION_DENIED
        trackError(new Error('Location permission denied'), {code: err.code});
        showDeniedOverlay(getLocationDeniedInstruction());
        document.getElementById('tagline').textContent = 'Location blocked';
      } else if (err.code === 2) { // POSITION_UNAVAILABLE
        setGpsBadge('denied', 'GPS unavailable');
        showLocationPrompt(true);
        document.getElementById('tagline').textContent = 'Location unavailable';
        showErrorBanner('Could not determine your location. Please check your device settings.');
      } else { // TIMEOUT
        setGpsBadge('denied', 'GPS timed out ‚Äî tap retry');
        showLocationPrompt(true);
        const lp = document.getElementById('location-prompt');
        if (lp) {
          lp.querySelector('.lp-headline').textContent = 'Location timed out';
          lp.querySelector('.lp-desc').textContent = 'Could not get your location. Check your connection and try again.';
        }
        document.getElementById('tagline').textContent = 'Location unavailable';
      }
    },
    {enableHighAccuracy:false, timeout:15000, maximumAge:30000}
  );
}

function isPositionTrustworthy(lat, lng, accuracy) {
  if (accuracy > 80) return false;
  if (_gpsReadingBuffer.length < GPS_CONFIDENCE_REQUIRED) {
    _gpsReadingBuffer.push({lat, lng, accuracy});
    return _gpsReadingBuffer.length >= GPS_CONFIDENCE_REQUIRED;
  }
  const avgLat = _gpsReadingBuffer.reduce((a,r)=>a+r.lat,0)/_gpsReadingBuffer.length;
  const avgLng = _gpsReadingBuffer.reduce((a,r)=>a+r.lng,0)/_gpsReadingBuffer.length;
  if (haversine(avgLat, avgLng, lat, lng) > 0.12) return false;
  _gpsReadingBuffer.push({lat, lng, accuracy});
  if (_gpsReadingBuffer.length > 10) _gpsReadingBuffer.shift();
  return true;
}

function startIdleWatch() {
  if (idleWatchId !== null) return;
  idleWatchId = navigator.geolocation.watchPosition(
    pos => { if (isWalking) return; userCenter = {lat:pos.coords.latitude, lng:pos.coords.longitude}; if (userMarker) userMarker.setPosition(userCenter); },
    err => { console.warn('Idle watch:', err.message); },
    {enableHighAccuracy:false, maximumAge:10000, timeout:20000}
  );
}

function onLocationReady() {
  locationReady = true;
  trackEvent('location_acquired');
  addBreadcrumb('location', 'GPS location acquired');
  const btn = document.getElementById('generate-btn');
  if (mapsReady) btn.disabled = false;
  document.getElementById('generate-waiting-msg').style.display = mapsReady ? 'none' : 'block';
  if (mapsReady && map) {
    map.setCenter(userCenter);
    map.setZoom(15);
  }
  showLocationPrompt(false);
  hideDeniedOverlay();
  setGpsBadge('ready', 'üìç Located');
  setTimeout(() => setGpsBadge('hidden'), 3000);
  if (mapsReady) {
    if (userMarker) userMarker.setMap(null);
    userMarker = new google.maps.Marker({
      position:userCenter, map,
      icon:{path:google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#7BADC4', fillOpacity:1, strokeColor:'white', strokeWeight:2},
      title:'Your location',
    });
  }
  detectCityGeocoder(userCenter.lat, userCenter.lng);
  fetchWeather(userCenter.lat, userCenter.lng);
}

// ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePref(el) {
  const p = el.dataset.pref;
  if (selectedPrefs.has(p)) {
    selectedPrefs.delete(p); el.classList.remove('active'); el.setAttribute('aria-pressed','false');
  } else {
    if (selectedPrefs.size >= MAX_PREFS) return;
    selectedPrefs.add(p); el.classList.add('active'); el.setAttribute('aria-pressed','true');
  }
  const atMax = selectedPrefs.size >= MAX_PREFS;
  document.querySelectorAll('.pref-chip').forEach(c => {
    if (!c.classList.contains('active')) c.classList.toggle('maxed', atMax);
  });
  const counter = document.getElementById('pref-counter');
  if (counter) {
    if (selectedPrefs.size === 0) counter.textContent = '';
    else counter.innerHTML = `<span>${selectedPrefs.size}</span> of ${MAX_PREFS} stops selected`;
  }
  updateGenerateLabel();
}

// ‚îÄ‚îÄ SLIDER & PRESETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPreset(miles) {
  slider.value = miles;
  slider.style.setProperty('--pct', ((miles-parseFloat(slider.min))/(parseFloat(slider.max)-parseFloat(slider.min)))*100+'%');
  slider.setAttribute('aria-valuetext', `${miles} ${unitLabel()}`);
  updateDistDisplay();
  document.querySelectorAll('.dist-preset').forEach(b => b.classList.toggle('active', parseFloat(b.textContent) === miles));
}
const slider = document.getElementById('dist-slider');
slider.addEventListener('input', () => {
  updateDistDisplay();
  slider.style.setProperty('--pct', ((slider.value-slider.min)/(slider.max-slider.min))*100+'%');
  slider.setAttribute('aria-valuetext', `${slider.value} ${unitLabel()}`);
});
slider.style.setProperty('--pct', '22.2%');

// ‚îÄ‚îÄ MAP STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAP_STYLES = [
  {featureType:'all',           elementType:'geometry',   stylers:[{color:'#f5efe6'}]},
  {featureType:'road',          elementType:'geometry',   stylers:[{color:'#ede0cc'}]},
  {featureType:'road.arterial', elementType:'geometry',   stylers:[{color:'#d4c5a9'}]},
  {featureType:'water',         elementType:'geometry',   stylers:[{color:'#a8cfe0'}]},
  {featureType:'poi.park',      elementType:'geometry',   stylers:[{color:'#c8dfc4'}]},
  {featureType:'poi',           elementType:'labels',     stylers:[{visibility:'off'}]},
  {featureType:'transit',                                 stylers:[{visibility:'off'}]},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñ∏ GOOGLE MAPS DYNAMIC LOADER
// ‚ñ∏ Uses the recommended async script injection pattern.
// ‚ñ∏ Falls back gracefully if the key is missing/invalid.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    // If already loaded (e.g. cached)
    if (window.google && window.google.maps) { resolve(); return; }

    // Validate API key
    if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === 'AIzaSyBxYn-xfG-fNzztVsos0RCsa-SBKHv2yTM_HERE') {
      document.getElementById('api-key-banner').style.display = 'block';
      const ph = document.getElementById('map-placeholder');
      if (ph) ph.innerHTML = '<span class="map-ph-icon">‚ö†Ô∏è</span>Add your Google Maps API key to load the map.';
      reject(new Error('No API key configured'));
      return;
    }

    // Create callback
    window._gmapsCallback = () => {
      delete window._gmapsCallback;
      resolve();
    };

    // Inject script
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=_gmapsCallback`;
    script.async = true;
    script.defer = true;
    script.onerror = () => {
      const ph = document.getElementById('map-placeholder');
      if (ph) ph.innerHTML = '<span class="map-ph-icon">‚ö†Ô∏è</span>Failed to load Google Maps.<br>Check your API key and internet connection.';
      showErrorBanner('Google Maps failed to load. Check your API key.');
      reject(new Error('Google Maps script failed to load'));
    };
    document.head.appendChild(script);
  });
}

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  // Service status logged after delay (scripts load async)
  setTimeout(() => {
    console.log(`%cüö∂ Walk Buddy ‚Äî Service Status`, 'font-weight:bold;font-size:14px');
    console.log(`  Sentry:   ${_sentryReady ? '‚úÖ Active' : '‚¨ö Not yet loaded'}`);
    console.log(`  PostHog:  ${_posthogReady ? '‚úÖ Active' : '‚¨ö Not yet loaded'}`);
    console.log(`  Supabase: ${_supaReady ? '‚úÖ Active' : '‚¨ö Not yet loaded'}`);
    if (_posthogReady && _supaUser) posthog.identify(_supaUser.id, {anonymous: true});
  }, 6000);

  // Always show stats and streak on load (no Maps needed)
  updateStreakUI();
  showStats('month', document.querySelector('.stats-tab.active'));
  checkWalkRecovery();

  try {
    await loadGoogleMaps();
  } catch(e) {
    trackError(e, {context: 'maps_load'});
    console.error('Maps load failed:', e.message);
    // App still works for stats display; route generation is disabled
    document.getElementById('generate-waiting-msg').textContent = 'Google Maps unavailable ‚Äî check API key';
    return;
  }

  mapsReady = true;

  // Remove placeholder
  const ph = document.getElementById('map-placeholder');
  if (ph) ph.remove();

  map = new google.maps.Map(document.getElementById('main-map'), {
    center:FALLBACK_CENTER, zoom:13, styles:MAP_STYLES,
    disableDefaultUI:true, zoomControl:true, gestureHandling:'greedy',
  });
  directionsService  = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    polylineOptions:{strokeColor:'#3D2B1F', strokeWeight:4, strokeOpacity:0.85},
    suppressMarkers:false,
  });
  directionsRenderer.setMap(map);
  placesService = new google.maps.places.PlacesService(map);

  // If location was already acquired before maps loaded
  if (locationReady && userCenter) {
    map.setCenter(userCenter);
    map.setZoom(15);
    document.getElementById('generate-btn').disabled = false;
    document.getElementById('generate-waiting-msg').style.display = 'none';
    if (userMarker) userMarker.setMap(null);
    userMarker = new google.maps.Marker({
      position:userCenter, map,
      icon:{path:google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#7BADC4', fillOpacity:1, strokeColor:'white', strokeWeight:2},
    });
  }

  // Location flow
  try {
    if (localStorage.getItem('wb_onboarded')) {
      const state = await checkLocationPermission();
      if (state === 'granted') { _acquireLocation(); }
      else if (state === 'denied') { showDeniedOverlay(getLocationDeniedInstruction()); }
      else { showLocationPrompt(true); setGpsBadge('locating', 'Tap Allow to start'); }
    } else {
      setGpsBadge('hidden');
      showLocationPrompt(false);
      initOnboarding();
    }
  } catch(e) {
    _acquireLocation();
  }
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);

// ‚îÄ‚îÄ RIPPLE EFFECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('click', e => {
  const btn = e.target.closest('.ripple-wrap');
  if (!btn || btn.disabled) return;
  const r = document.createElement('span');
  r.className = 'ripple-circle';
  const rect = btn.getBoundingClientRect();
  r.style.left = (e.clientX - rect.left) + 'px';
  r.style.top  = (e.clientY - rect.top)  + 'px';
  btn.appendChild(r);
  r.addEventListener('animationend', () => r.remove());
});

// ‚îÄ‚îÄ OFFLINE / CONNECTIVITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('offline', () => showErrorBanner('No internet connection ‚Äî some features may not work.'));
window.addEventListener('online',  () => { const b = document.getElementById('error-banner'); if(b) b.style.display='none'; });
window.addEventListener('load', () => { if (!navigator.onLine) showErrorBanner('You appear to be offline. Connect to generate routes.'); });
function toggleMapLock() {
  mapLocked = !mapLocked;
  const btn = document.getElementById('map-lock-btn');
  btn.textContent = mapLocked ? 'üìç Following' : 'üîì Free scroll';
  btn.classList.toggle('locked', mapLocked);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(a,b,c,d) {
  const R=3958.8,dL=(c-a)*Math.PI/180,dl=(d-b)*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function getBearing(a,b,c,d) {
  const dl=(d-b)*Math.PI/180;
  return (Math.atan2(Math.sin(dl)*Math.cos(c*Math.PI/180),Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos(dl))*180/Math.PI+360)%360;
}
function turnArrow(t) {
  t=(t||'').toLowerCase();
  if(t.includes('left'))return'‚Ü∞'; if(t.includes('right'))return'‚Ü±';
  if(t.includes('u-turn'))return'‚Ü©'; if(t.includes('arrive')||t.includes('destination'))return'üèÅ';
  return'‚Üë';
}
function show(id,flex) { const el=document.getElementById(id); if(el) el.style.display=flex?'flex':'block'; }
function hide(id)       { const el=document.getElementById(id); if(el) el.style.display='none'; }

// ‚îÄ‚îÄ LOADING PHRASE CYCLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startLoadingPhrases() {
  let i = 0;
  const phrases = crazyMode ? CRAZY_LOADING_PHRASES : LOADING_PHRASES;
  const sub = document.getElementById('loading-sub');
  if (sub) sub.textContent = phrases[0];
  _loadingPhraseInterval = setInterval(() => {
    if (!sub) return;
    sub.style.opacity = '0';
    setTimeout(() => { i = (i+1) % phrases.length; sub.textContent = phrases[i]; sub.style.opacity = '1'; }, 200);
  }, 2800);
}
function stopLoadingPhrases() {
  clearInterval(_loadingPhraseInterval);
  _loadingPhraseInterval = null;
}

// ‚îÄ‚îÄ GENERATE ROUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateRoute() {
  if (isGenerating || !locationReady || !mapsReady) return;
  isGenerating = true;
  requestedMiles = parseFloat(slider.value);
  trackEvent('route_generate_started', {
    distanceMiles: requestedMiles, crazyMode, preferences: [...selectedPrefs],
    unit: useKm ? 'km' : 'miles',
  });
  addBreadcrumb('navigation', 'Route generation started', {distance: requestedMiles});
  const center = userCenter || FALLBACK_CENTER;
  const btn = document.getElementById('generate-btn');
  btn.disabled = true;
  btn.querySelector('#generate-btn-label').textContent = 'Finding route‚Ä¶';
  hide('planner-card'); show('loading-box', true); startLoadingPhrases();
  // Update loading title for crazy mode
  const loadingText = document.getElementById('loading-text');
  if (loadingText) loadingText.textContent = crazyMode ? 'Building your crazy route‚Ä¶' : 'Building your route‚Ä¶';
  hide('route-info-wrap'); hide('ready-card'); hide('saved-route-bar');
  hide('turn-banner'); hide('nav-stats-wrap'); hide('streak-banner'); hide('recap-card'); hide('dist-mismatch');
  const ec=document.getElementById('error-card'); if(ec) ec.style.display='none';
  document.querySelectorAll('.new-route-btn').forEach(b=>b.remove());
  map.setZoom(14); map.setCenter(center);

  const waypoints=[], foundSpots=[];
  const types=[...selectedPrefs].map(p=>prefToType[p]).filter(Boolean);
  const uniqueTypes=[...new Set(types)];
  const angles=[0,90,180,270,45,135,225,315]; let ai=0;
  const mpm=1609.34, radius=Math.max(200, (requestedMiles/4)*mpm);

  if (uniqueTypes.length>0) {
    try {
      await Promise.all(uniqueTypes.slice(0,3).map(type=>new Promise(resolve=>{
        const angle=(angles[ai++%angles.length]*Math.PI)/180;
        const oLat=center.lat+(radius/111320)*Math.sin(angle);
        const oLng=center.lng+(radius/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle);
        placesService.nearbySearch({location:{lat:oLat,lng:oLng},radius:Math.min(radius*1.5, 5000),type},(results,status)=>{
          if(status==='OK'&&results&&results.length>0){
            const pick=results[Math.floor(Math.random()*Math.min(5,results.length))];
            waypoints.push({location:{lat:pick.geometry.location.lat(),lng:pick.geometry.location.lng()},stopover:false});
            foundSpots.push({name:pick.name,type:[...selectedPrefs].find(p=>prefToType[p]===type)});
          }
          resolve();
        });
      })));
    } catch(e) { console.warn('Places search error:',e); }
  }

  // Always create at least one waypoint to make a loop
  if (waypoints.length===0) {
    const angle=Math.random()*2*Math.PI, d=(requestedMiles/3.5)*mpm;
    waypoints.push({location:{lat:center.lat+(d/111320)*Math.sin(angle),lng:center.lng+(d/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle)},stopover:false});
  }

  // Add a second waypoint on the opposite side for better loops
  if (waypoints.length === 1 && !crazyMode) {
    const wp = waypoints[0].location;
    const oppLat = center.lat - (wp.lat - center.lat) * 0.7;
    const oppLng = center.lng - (wp.lng - center.lng) * 0.7;
    waypoints.push({location:{lat:oppLat, lng:oppLng}, stopover:false});
  }

  // ‚îÄ‚îÄ CRAZY MODE: scatter zigzag waypoints ‚îÄ‚îÄ
  if (crazyMode) {
    // Google Directions API allows max 8 waypoints on free tier
    // We use remaining slots (after POI waypoints) for random zigzag points
    const maxWaypoints = 8;
    const slotsAvailable = maxWaypoints - waypoints.length;
    const numZigzag = Math.max(3, Math.min(slotsAvailable, Math.floor(2 + requestedMiles * 1.5)));
    const zigzagRadius = (requestedMiles / 3) * mpm; // base scatter radius in meters

    // Generate points in a starburst/zigzag pattern
    // Alternate between close and far, with random angular offsets
    const baseAngle = Math.random() * 2 * Math.PI; // random starting direction
    for (let i = 0; i < numZigzag; i++) {
      // Spread points around the circle with jitter
      const angleFraction = (i / numZigzag) * 2 * Math.PI;
      const jitter = (Math.random() - 0.5) * (Math.PI / 3); // ¬±30¬∞ wobble
      const angle = baseAngle + angleFraction + jitter;

      // Alternate near/far to create zigzag effect
      const distFactor = (i % 2 === 0)
        ? 0.3 + Math.random() * 0.35   // near: 30-65% of radius
        : 0.65 + Math.random() * 0.45;  // far: 65-110% of radius
      const dist = zigzagRadius * distFactor;

      const lat = center.lat + (dist / 111320) * Math.sin(angle);
      const lng = center.lng + (dist / (111320 * Math.cos(center.lat * Math.PI / 180))) * Math.cos(angle);
      waypoints.push({location:{lat, lng}, stopover:false});
    }

    // DON'T optimize waypoint order ‚Äî the chaotic ordering IS the zigzag
  }

  // For crazy mode, tell Directions not to optimize so it respects our zigzag order
  const optimizeWaypoints = !crazyMode;

  tryRoute(center, waypoints, foundSpots, requestedMiles, 0, null, optimizeWaypoints);
}

function tryRoute(center, waypoints, foundSpots, targetMiles, attempt, prevTimeoutId, optimizeWaypoints) {
  if (typeof optimizeWaypoints === 'undefined') optimizeWaypoints = true;
  if (prevTimeoutId !== null) clearTimeout(prevTimeoutId);
  show('loading-box', true);
  const timeoutId = setTimeout(()=>{ stopLoadingPhrases(); hide('loading-box'); showRouteError('Request timed out ‚Äî check your connection and try again.'); }, 30000);
  try {
    directionsService.route({
      origin:center, destination:center,
      waypoints, travelMode:'WALKING',
      optimizeWaypoints, avoidHighways:true, avoidTolls:true
    },(result,status)=>{
      clearTimeout(timeoutId);
      if (status==='OK') {
        const legs=result.routes[0].legs; let totalDist=0,totalTime=0;
        legs.forEach(l=>{totalDist+=l.distance.value;totalTime+=l.duration.value;});
        const distMiles=totalDist/1609.34, ratio=distMiles/targetMiles;
        // Wider tolerance in crazy mode since zigzag naturally adds distance
        const hiThresh = crazyMode ? 2.0 : 1.35;
        const loThresh = crazyMode ? 0.5 : 0.65;
        // If distance is way off, try scaling waypoints (up to 3 attempts)
        if ((ratio>hiThresh||ratio<loThresh)&&attempt<3) {
          const scale=Math.sqrt(targetMiles/distMiles); // use sqrt for gentler scaling
          const scaled = waypoints.map(wp=>({
            location:{
              lat:center.lat+(wp.location.lat-center.lat)*scale,
              lng:center.lng+(wp.location.lng-center.lng)*scale
            },stopover:false
          }));
          tryRoute(center,scaled,foundSpots,targetMiles,attempt+1,timeoutId,optimizeWaypoints);
          return;
        }
        stopLoadingPhrases(); hide('loading-box'); finishRoute(result,distMiles,totalTime,foundSpots,targetMiles);
      } else if (status === 'ZERO_RESULTS') {
        stopLoadingPhrases(); hide('loading-box'); showRouteError('No walking route found in this area. Try a shorter distance.');
      } else if (status === 'OVER_QUERY_LIMIT' || status === 'REQUEST_DENIED') {
        stopLoadingPhrases(); hide('loading-box'); showRouteError(`API error: ${status}. Check your Google Maps API key has Directions API enabled.`);
      } else {
        stopLoadingPhrases(); hide('loading-box'); showRouteError(`Route unavailable (${status}) ‚Äî try different preferences or a shorter distance.`);
      }
    });
  } catch(e) { clearTimeout(timeoutId); stopLoadingPhrases(); hide('loading-box'); showRouteError('Something went wrong building the route. Please try again.'); console.error('Route error:',e); }
}

function finishRoute(result, distMiles, totalTime, foundSpots, targetMiles) {
  trackEvent('route_generated', {
    actualMiles: distMiles, targetMiles, spots: foundSpots.length,
    crazyMode, estimatedMinutes: Math.round(totalTime / 60),
  });
  addBreadcrumb('navigation', 'Route generated', {miles: distMiles});
  lastDirectionsResult=result; actualRouteMiles=distMiles;
  allSteps=[]; routeStepCumulativeMiles=[];
  let cumulative=0;
  result.routes[0].legs.forEach(l=>l.steps.forEach(s=>{
    allSteps.push({instruction:s.instructions.replace(/<[^>]*>/g,''),distance:s.distance.text,distMiles:s.distance.value/1609.34,lat:s.start_location.lat(),lng:s.start_location.lng()});
    routeStepCumulativeMiles.push(cumulative);
    cumulative+=s.distance.value/1609.34;
  }));
  directionsRenderer.setDirections(result);

  const estSteps = Math.round(distMiles * STEPS_PER_MILE);
  document.getElementById('route-pills').innerHTML=`
    <div class="info-pill"><div class="val">${milesToDisplay(distMiles)}</div><div class="lbl">${unitLabel()}</div></div>
    <div class="info-pill"><div class="val">${Math.round(totalTime/60)}</div><div class="lbl">Est. Min</div></div>
    <div class="info-pill"><div class="val">${estSteps.toLocaleString()}</div><div class="lbl">Est. Steps</div></div>`;

  // Distance mismatch notice (wider tolerance in crazy mode since zigzag adds length)
  const ratio=distMiles/targetMiles, mismatch=document.getElementById('dist-mismatch');
  const mismatchThreshold = crazyMode ? 1.5 : 1.15;
  const mismatchThresholdLow = crazyMode ? 0.6 : 0.85;
  if (ratio>mismatchThreshold||ratio<mismatchThresholdLow) {
    const dir=ratio>1?'longer':'shorter';
    mismatch.textContent=crazyMode
      ? `Your crazy ${milesToDisplay(targetMiles)} ${unitLabel()} route came out to ${milesToDisplay(distMiles)} ${unitLabel()} ‚Äî zigzag routes are naturally ${dir}!`
      : `Your ${milesToDisplay(targetMiles)} ${unitLabel()} request generated a ${milesToDisplay(distMiles)} ${unitLabel()} route ‚Äî the best available loop here is ${dir}.`;
    mismatch.style.display='block';
  } else { mismatch.style.display='none'; }

  const sl=document.getElementById('spots-list');
  const missingPrefs=[...selectedPrefs].filter(p=>prefToType[p]&&!foundSpots.some(s=>s.type===p));
  if (foundSpots.length>0) {
    let html=`<div class="spots-title">Along your route</div>`;
    html+=foundSpots.map(s=>`<div class="spot-item"><div class="spot-icon" aria-hidden="true">${prefEmoji[s.type]||'üìç'}</div><div><div class="spot-name">${s.name}</div><div class="spot-type">${s.type?s.type.charAt(0).toUpperCase()+s.type.slice(1):'Point of interest'}</div></div></div>`).join('');
    if(missingPrefs.length>0) html+=`<div class="poi-feedback">No ${missingPrefs.join(', ')} found nearby ‚Äî route optimized without them.</div>`;
    sl.innerHTML=html; sl.style.display='block';
  } else if(selectedPrefs.size>0) {
    sl.innerHTML=`<div class="poi-feedback">No matching spots found nearby ‚Äî generated a scenic loop instead.</div>`;
    sl.style.display='block';
  } else { sl.style.display='none'; }

  show('route-info-wrap','flex'); show('ready-card');
  document.getElementById('ready-sub').textContent = crazyMode
    ? `${milesToDisplay(distMiles)} ${unitLabel()} zigzag route ready. Hold on tight! ü§™`
    : `${milesToDisplay(distMiles)} ${unitLabel()} loop ready. Let's go!`;
  isGenerating=false;
  const btn=document.getElementById('generate-btn');
  btn.disabled=false; btn.querySelector('#generate-btn-label').textContent='Generate My Walk'; updateGenerateLabel();

  // Fit map to route
  const bounds = new google.maps.LatLngBounds();
  result.routes[0].legs.forEach(l => {
    bounds.extend(l.start_location);
    bounds.extend(l.end_location);
  });
  map.fitBounds(bounds, {top:20, bottom:20, left:20, right:20});
}

function showRouteError(msg) {
  isGenerating=false;
  trackError(new Error('Route generation failed'), {message: msg, distance: requestedMiles, crazyMode});
  trackEvent('route_error', {message: msg, distance: requestedMiles});
  const btn=document.getElementById('generate-btn');
  btn.disabled=false; btn.querySelector('#generate-btn-label').textContent='Generate My Walk'; updateGenerateLabel();
  const card=document.getElementById('error-card'), cardMsg=document.getElementById('error-card-msg');
  if(card) card.style.display='block';
  if(cardMsg&&msg) cardMsg.textContent=msg;
  show('planner-card');
}

// ‚îÄ‚îÄ SAVE ROUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveRouteForLater() {
  hide('ready-card'); show('saved-route-bar','flex'); hide('planner-card');
}

// ‚îÄ‚îÄ ACCELEROMETER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAccelerometer() {
  if (!window.DeviceMotionEvent) return;
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission().then(s => { if (s==='granted') attachAccelerometer(); }).catch(()=>{});
  } else { attachAccelerometer(); }
}
function attachAccelerometer() { _usingAccelerometer=true; window.addEventListener('devicemotion',onDeviceMotion); }
function detachAccelerometer() { window.removeEventListener('devicemotion',onDeviceMotion); _usingAccelerometer=false; }
function onDeviceMotion(e) {
  if (!isWalking||isPaused) return;
  const acc=e.accelerationIncludingGravity; if(!acc||acc.x==null) return;
  const mag=Math.sqrt(acc.x**2+acc.y**2+acc.z**2);
  _accelBuffer.push(mag); if(_accelBuffer.length>25) _accelBuffer.shift();
  const mean=_accelBuffer.reduce((a,b)=>a+b,0)/_accelBuffer.length;
  const now=Date.now();
  if(mag>mean+2.8&&now-_accelLastPeak>350){ _accelStepCount++; _accelLastPeak=now; }
}

// ‚îÄ‚îÄ START WALKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startWalking() {
  if (!mapsReady) { showErrorBanner('Map not loaded yet.'); return; }
  trackEvent('walk_started', {routeMiles: actualRouteMiles, crazyMode});
  addBreadcrumb('navigation', 'Walk started');
  hide('ready-card'); hide('route-info-wrap'); hide('saved-route-bar');
  isWalking=true;
  document.body.classList.add('walking');
  window._walkUnloadHandler = e => { e.preventDefault(); e.returnValue='Your walk is in progress.'; return e.returnValue; };
  window.addEventListener('beforeunload', window._walkUnloadHandler);
  window._totalPausedMs=0;
  window._walkAutoSaveInterval=setInterval(saveWalkState,10000);

  const lockBtn=document.getElementById('map-lock-btn');
  if(lockBtn){ lockBtn.style.display='block'; mapLocked=true; lockBtn.textContent='üìç Following'; lockBtn.classList.add('locked'); }

  const center=userCenter||FALLBACK_CENTER;
  map.setZoom(17); map.setCenter(center);
  if(userMarker) userMarker.setMap(null);
  userMarker=new google.maps.Marker({position:center,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:'#4285F4',fillOpacity:1,strokeColor:'white',strokeWeight:2.5},zIndex:999});
  if(walkedPath) walkedPath.setMap(null);
  walkedPath=new google.maps.Polyline({path:[],map,strokeColor:'#4285F4',strokeWeight:5,strokeOpacity:0.8});
  show('turn-banner','flex'); show('nav-stats-wrap','flex');
  updateTurnBanner();

  walkDistanceMiles=0; walkStartTime=Date.now(); isPaused=false; walkUnlocked=false;
  currentStepIndex=0; lastGeoPos=null; lastHeading=null;
  _accelStepCount=0; _accelBuffer=[]; _accelLastPeak=0; _gpsReadingBuffer=[];
  let _lastGpsTime = null;

  const completePFill=document.getElementById('complete-progress-fill');
  if(completePFill) completePFill.style.width='0%';
  const cb=document.getElementById('complete-btn');
  cb.classList.remove('unlocked'); cb.disabled=true; cb.setAttribute('aria-disabled','true');
  document.getElementById('complete-hint').textContent='Walk 65% of your route to unlock';
  document.getElementById('pause-btn').textContent='‚è∏ Pause';
  document.getElementById('nav-progress').style.width='0%';
  document.getElementById('nav-progress').setAttribute('aria-valuenow','0');

  initAccelerometer();

  walkTimerInterval=setInterval(()=>{
    if(isPaused) return;
    const e=Math.floor((Date.now()-walkStartTime)/1000),m=Math.floor(e/60),s=e%60;
    finalWalkTime=`${m}:${s.toString().padStart(2,'0')}`;
    requestAnimationFrame(()=>{
      document.getElementById('nav-timer').textContent=finalWalkTime;
      document.getElementById('n-time').textContent=finalWalkTime;
    });
  },1000);

  setTimeout(()=>{ const p=document.getElementById('pause-btn'); if(p) p.focus(); },100);

  if(navigator.geolocation){
    geoWatchId=navigator.geolocation.watchPosition(pos=>{
      if(isPaused) return;
      const {latitude:lat,longitude:lng,accuracy}=pos.coords;
      if(!isPositionTrustworthy(lat,lng,accuracy)) return;
      const raw={lat,lng};
      let sf=0.30;
      if(lastGeoPos&&lastHeading!==null){
        const nb=getBearing(lastGeoPos.lat,lastGeoPos.lng,raw.lat,raw.lng);
        const nd=Math.min(Math.abs(nb-lastHeading),360-Math.abs(nb-lastHeading));
        if(nd>35) sf=0.05;
      }
      const curr=lastGeoPos?{lat:lastGeoPos.lat*sf+raw.lat*(1-sf),lng:lastGeoPos.lng*sf+raw.lng*(1-sf)}:raw;
      if(lastGeoPos){
        const d=haversine(lastGeoPos.lat,lastGeoPos.lng,curr.lat,curr.lng);
        const now=Date.now(), elapsed=_lastGpsTime?(now-_lastGpsTime)/3600000:0.001;
        _lastGpsTime=now;
        const speed=elapsed>0?d/elapsed:0;
        if(d>0.005&&d<0.093&&speed<15){
          walkDistanceMiles+=d;
          const heading=getBearing(lastGeoPos.lat,lastGeoPos.lng,curr.lat,curr.lng);
          lastHeading=heading;
          try { map.setHeading(heading); } catch(e) {}
          walkedPath.getPath().push(new google.maps.LatLng(curr.lat,curr.lng));
        }
      }
      userMarker.setPosition(curr);
      if(mapLocked) map.panTo(curr);
      lastGeoPos=curr;
      _pendingNavUpdate=curr;
      if(!_rafPending){
        _rafPending=true;
        requestAnimationFrame(()=>{ if(_pendingNavUpdate) updateNavUI(_pendingNavUpdate); _rafPending=false; _pendingNavUpdate=null; });
      }
    },err=>{trackError(err, {context:'gps_watch', walking: isWalking});},{enableHighAccuracy:true,maximumAge:3000,timeout:15000});
  }
}

function updateTurnBanner() {
  if(!allSteps.length) return;
  const s=allSteps[Math.min(currentStepIndex,allSteps.length-1)];
  document.getElementById('turn-arrow').textContent=turnArrow(s.instruction);
  document.getElementById('turn-instruction').textContent=s.instruction;
  document.getElementById('turn-dist').textContent=s.distance||'';
}

function getRouteProgress() {
  if(!lastGeoPos||!allSteps.length) return actualRouteMiles > 0 ? walkDistanceMiles/actualRouteMiles : 0;
  let nearestIdx=0, nearestDist=Infinity;
  allSteps.forEach((s,i)=>{ const d=haversine(lastGeoPos.lat,lastGeoPos.lng,s.lat,s.lng); if(d<nearestDist){nearestDist=d;nearestIdx=i;} });
  return Math.min((routeStepCumulativeMiles[nearestIdx]||0)/actualRouteMiles,1);
}

function updateNavUI(curr) {
  const routePct=getRouteProgress(), displayPct=Math.round(routePct*100);
  document.getElementById('n-dist').textContent=milesToDisplay(walkDistanceMiles);
  const stepDisplay=_usingAccelerometer&&_accelStepCount>10?_accelStepCount:Math.round(walkDistanceMiles*STEPS_PER_MILE);
  document.getElementById('n-steps').textContent=stepDisplay.toLocaleString();
  document.getElementById('n-pct').textContent=displayPct+'%';
  const bar=document.getElementById('nav-progress');
  bar.style.width=displayPct+'%'; bar.setAttribute('aria-valuenow',displayPct);

  const fill=document.getElementById('complete-progress-fill');
  if(fill) fill.style.width=Math.min(routePct/0.65,1)*100+'%';

  if(currentStepIndex<allSteps.length-1){
    const next=allSteps[currentStepIndex+1];
    if(haversine(curr.lat,curr.lng,next.lat,next.lng)<0.04){
      currentStepIndex++; updateTurnBanner();
      if(voiceEnabled){
        try{const u=new SpeechSynthesisUtterance(allSteps[currentStepIndex].instruction);u.rate=0.95;window.speechSynthesis.speak(u);}catch(e){}
      }
    }
  }

  if(routePct>=0.65&&!walkUnlocked){
    walkUnlocked=true;
    const btn=document.getElementById('complete-btn');
    btn.classList.add('unlocked'); btn.disabled=false; btn.setAttribute('aria-disabled','false');
    document.getElementById('complete-hint').textContent="You've earned it ‚Äî tap to complete! üéâ";
    if(fill) fill.style.width='100%';
  }
}

// ‚îÄ‚îÄ PAUSE / CANCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePause() {
  isPaused=!isPaused;
  const btn=document.getElementById('pause-btn');
  btn.textContent=isPaused?'‚ñ∂ Resume':'‚è∏ Pause';
  btn.setAttribute('aria-label',isPaused?'Resume walk':'Pause walk');
}
function cancelWalk() {
  stopTracking(); isWalking=false;
  hide('turn-banner'); hide('nav-stats-wrap');
  const lockBtn=document.getElementById('map-lock-btn'); if(lockBtn) lockBtn.style.display='none';
  map.setZoom(14); try{map.setHeading(0);}catch(e){}
  if(lastDirectionsResult) directionsRenderer.setDirections(lastDirectionsResult);
  show('route-info-wrap','flex'); show('ready-card');
  document.getElementById('ready-sub').textContent='Walk cancelled. Ready to try again?';
}
function stopTracking() {
  if(geoWatchId!==null){navigator.geolocation.clearWatch(geoWatchId);geoWatchId=null;}
  clearInterval(walkTimerInterval); clearInterval(window._walkAutoSaveInterval);
  document.body.classList.remove('walking');
  if(window._walkUnloadHandler){window.removeEventListener('beforeunload',window._walkUnloadHandler);window._walkUnloadHandler=null;}
  detachAccelerometer();
  try{window.speechSynthesis.cancel();}catch(e){}
  try{localStorage.removeItem('wb_walk_inprogress');}catch(e){}
}

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fireConfetti() {
  const container=document.getElementById('recap-confetti');
  if(!container) return;
  container.innerHTML='';
  const emojis=['üéâ','‚≠ê','‚ú®','üåü','üéä','üí´'];
  for(let i=0;i<12;i++){
    const s=document.createElement('span');
    s.textContent=emojis[i%emojis.length];
    s.style.cssText=`left:${5+Math.random()*90}%;top:-10px;animation-delay:${Math.random()*0.6}s;animation-duration:${1.4+Math.random()*0.8}s;font-size:${0.9+Math.random()*0.6}rem;`;
    container.appendChild(s);
  }
  setTimeout(()=>{ container.innerHTML=''; },3000);
}

// ‚îÄ‚îÄ COMPLETE WALK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function completeWalk() {
  const btn=document.getElementById('complete-btn');
  if(btn.dataset.completing==='1') return;
  btn.dataset.completing='1';

  stopTracking(); isWalking=false;
  hide('turn-banner'); hide('nav-stats-wrap');
  const lockBtn=document.getElementById('map-lock-btn'); if(lockBtn) lockBtn.style.display='none';
  map.setZoom(14); try{map.setHeading(0);}catch(e){}
  const finalMiles=Math.max(walkDistanceMiles,actualRouteMiles*0.65);
  const finalSteps=_usingAccelerometer&&_accelStepCount>10?_accelStepCount:Math.round(finalMiles*STEPS_PER_MILE);
  trackEvent('walk_completed', {
    miles: parseFloat(finalMiles.toFixed(2)), steps: finalSteps,
    routeMiles: actualRouteMiles, duration: finalWalkTime, crazyMode,
    accelerometerUsed: _usingAccelerometer,
  });
  logWalkStats(finalMiles.toFixed(2));
  showStats('month',document.querySelector('.stats-tab.active'));
  const newStreak=recordWalk(finalMiles); updateStreakUI();

  // Hero recap
  document.getElementById('recap-hero-dist').textContent=milesToDisplay(finalMiles);
  document.getElementById('recap-hero-unit').textContent=`${unitLabel()} walked`;
  document.getElementById('recap-hero-streak').textContent=`üî• ${newStreak} day streak`;
  const day=new Date().toLocaleDateString('en-US',{weekday:'long'});
  document.getElementById('recap-title').textContent=`${day} walk complete!`;
  document.getElementById('recap-subtitle').textContent=`Great work ‚Äî see you tomorrow!`;
  document.getElementById('recap-steps').textContent=finalSteps.toLocaleString();
  document.getElementById('recap-time').textContent=finalWalkTime;
  show('recap-card');
  fireConfetti();

  // Streak banner
  document.getElementById('streak-banner-num').textContent=`üî• ${newStreak} Day Streak!`;
  const msgs={1:'You started ‚Äî come back tomorrow!',7:'üèÜ 7 days! You crushed it!'};
  document.getElementById('streak-banner-msg').textContent=msgs[newStreak]||(newStreak%7===0?`${newStreak} days strong!`:`${7-(newStreak%7)} days to your next milestone!`);
  show('streak-banner');

  delete btn.dataset.completing;
}

// ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shareRecap() {
  const dist=document.getElementById('recap-hero-dist').textContent;
  const steps=document.getElementById('recap-steps').textContent;
  trackEvent('walk_shared', {distance: dist, steps});
  const text=`Just walked ${dist} ${unitLabel()} (${steps} steps) with Walk Buddy! üö∂‚Äç‚ôÄÔ∏èüî•`;
  if(navigator.share){navigator.share({title:'My Walk Buddy walk',text}).catch(()=>{});}
  else{navigator.clipboard.writeText(text).then(()=>showErrorBanner('Copied to clipboard!')).catch(()=>{});}
}

// ‚îÄ‚îÄ END WALK EARLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _doEndWalkEarly() {
  stopTracking(); isWalking=false;
  trackEvent('walk_ended_early', {miles: walkDistanceMiles, duration: finalWalkTime});
  hide('turn-banner'); hide('nav-stats-wrap');
  const lockBtn=document.getElementById('map-lock-btn'); if(lockBtn) lockBtn.style.display='none';
  map.setZoom(14); try{map.setHeading(0);}catch(e){}
  if(walkDistanceMiles>0.05){
    const finalSteps=_usingAccelerometer&&_accelStepCount>10?_accelStepCount:Math.round(walkDistanceMiles*STEPS_PER_MILE);
    logWalkStats(walkDistanceMiles.toFixed(2));
    showStats('month',document.querySelector('.stats-tab.active'));
    document.getElementById('recap-hero-dist').textContent=milesToDisplay(walkDistanceMiles);
    document.getElementById('recap-hero-unit').textContent=`${unitLabel()} walked`;
    document.getElementById('recap-hero-streak').textContent='Finish 65% next time for streak';
    document.getElementById('recap-title').textContent='Walk ended early';
    document.getElementById('recap-subtitle').textContent='Distance saved ‚Äî streak requires 65% of route';
    document.getElementById('recap-steps').textContent=finalSteps.toLocaleString();
    document.getElementById('recap-time').textContent=finalWalkTime;
    show('recap-card');
  } else { resetPlanner(); }
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetPlanner() {
  stopTracking(); isWalking=false; isGenerating=false;
  hide('route-info-wrap'); hide('ready-card'); hide('saved-route-bar');
  hide('turn-banner'); hide('nav-stats-wrap'); hide('streak-banner');
  hide('recap-card'); hide('dist-mismatch');
  const ec=document.getElementById('error-card'); if(ec) ec.style.display='none';
  showLocationPrompt(false);
  const lockBtn=document.getElementById('map-lock-btn'); if(lockBtn) lockBtn.style.display='none';
  document.querySelectorAll('.new-route-btn').forEach(b=>b.remove());
  show('planner-card');
  if(mapsReady){
    try{directionsRenderer.setDirections({routes:[]});}catch(e){}
    if(walkedPath){walkedPath.setMap(null);walkedPath=null;}
    const center=userCenter||FALLBACK_CENTER;
    map.setCenter(center); map.setZoom(locationReady?15:13); try{map.setHeading(0);}catch(e){}
    if(userMarker) userMarker.setMap(null);
    if(locationReady && center) userMarker=new google.maps.Marker({position:center,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:'#7BADC4',fillOpacity:1,strokeColor:'white',strokeWeight:2}});
  }
  const btn=document.getElementById('generate-btn');
  btn.disabled=!(locationReady && mapsReady);
  btn.querySelector('#generate-btn-label').textContent='Generate My Walk';
  document.getElementById('generate-waiting-msg').style.display = (locationReady && mapsReady) ? 'none' : 'block';
  if (!locationReady) document.getElementById('generate-waiting-msg').textContent = 'Waiting for your location‚Ä¶';
  else if (!mapsReady) document.getElementById('generate-waiting-msg').textContent = 'Waiting for map to load‚Ä¶';
  isPaused=false; walkUnlocked=false; mapLocked=true;
  _gpsReadingBuffer=[]; _accelStepCount=0;
  stopLoadingPhrases();
  updateGenerateLabel();
}
</script>
</body>
</html>
